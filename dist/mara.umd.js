!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("nanoid"),require("file-saver"),require("sweetalert2")):"function"==typeof define&&define.amd?define(["nanoid","file-saver","sweetalert2"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).Mara=t(e.nanoid,e.FileSaver,e.Swal)}(this,(function(e,t,o){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var i=n(t),s=n(o);let r;const a={qq:/\bm?qqbrowser\/([0-9.]+)/,360:e=>-1!==e.indexOf("360 aphone browser")?/\b360 aphone browser \(([^\)]+)\)/:/\b360(?:se|ee|chrome|browser)\b/,aoyou:/\baoyou/,webview:/\bcpu(?: iphone)? os (?:[0-9._]+).+\bapplewebkit\b/,firefox:/\bfirefox\/([0-9.ab]+)/,chrome:/ (?:chrome|crios|crmo)\/([0-9.]+)/,ie:/\b(?:msie |ie |trident\/[0-9].*rv[ :])([0-9.]+)/,android:e=>-1===e.indexOf("android")?"":/\bversion\/([0-9.]+(?: beta)?)/,safari:/\bversion\/([0-9.]+(?: beta)?)(?: mobile(?:\/[a-z0-9]+)?)? safari\//,opera:/\bopera/,unknow:"unknow"},h={windows:/\bwindows nt ([0-9.]+)/,macosx:/\bmac os x ([0-9._]+)/,linux:"linux",wphone:e=>-1!==e.indexOf("windows phone ")?/\bwindows phone (?:os )?([0-9.]+)/:-1!==e.indexOf("xblwp")?/\bxblwp([0-9.]+)/:-1!==e.indexOf("zunewp")?/\bzunewp([0-9.]+)/:"windows phone",ios:e=>/\bcpu(?: iphone)? os /.test(e)?/\bcpu(?: iphone)? os ([0-9._]+)/:-1!==e.indexOf("iph os ")?/\biph os ([0-9_]+)/:/\bios\b/,android:e=>e.indexOf("android")>=0?/\bandroid[ \/-]?([0-9.x]+)?/:e.indexOf("adr")>=0?e.indexOf("mqqbrowser")>=0?/\badr[ ]\(linux; u; ([0-9.]+)?/:/\badr(?:[ ]([0-9.]+))?/:"android",unknow:"unknow"},c={weixin:/micromessenger/gi,qqvideo:/qqlivebrowser/gi,qqvideoipad:/qqlivehdbrowser/gi,shouqq:/qq\//gi,qqnews:/qqnews/gi,qzone:/qzone\//gi,unknow:"unknow"},p=(e,t)=>Object.prototype.toString.call(e)===`[object ${t}]`,u=(e,t)=>{const o=f[e.toLowerCase()];for(const e in t){const n=t[e],i=p(n,"Function")?n(d()):n;if(o.name=e,!0===i)break;if("[object String]"===toString(i)){if(-1!==d().indexOf(i))break}else if(p(i,"Object")){if(void 0!==i.version){o.version=i.version;break}}else if(i&&i.exec){const e=i.exec(d());if(e){e.length>=2&&e[1]?o.version=e[1].replace(/_/g,"."):o.version="0.0.0";break}}}return o},d=()=>{if(!r){const e="__",t=navigator.userAgent||"",o=navigator.platform||"",n=navigator.appVersion||"",i=navigator.vendor||"";r=t+e+o+e+n+e+i,r=r.toLowerCase()}return r},l=e=>{r||(u("os",h),u("platform",c),u("browser",a));return"all"===e||"full"===e?d():void 0!==e?f[e].name:`${f.os.name}  _${f.os.version}  ${f.browser.name}  _${f.browser.version}`},f={os:{name:"unknow",version:"0.0.0"},platform:{name:"unknow",version:"0.0.0"},browser:{name:"unknow",version:"0.0.0"}},m=(...e)=>{const t=e[0],o=Array.prototype.slice.call(e,1);for(let e=0;e<o.length;e++){const n=o[e];for(const e in n)t[e]=n[e]}return t},w=e=>{if(!e)return!0;if(!e.length)return!0;let t=0;for(let o=e.length-1;o>0;o--)e[o]||(t+=1);return t>e.length-1},g=e=>{const t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";e=e||9;let o="";for(let n=0;n<e;n++)o+=t.charAt(Math.floor(Math.random()*t.length));return o};class b{constructor(){if(b.instance)return b.instance;this.__pool__={},b.instance=this}setItem(e,t){this.__pool__[e]=t}getItem(e){return this.__pool__[e]}remove(e){this.__pool__[e]=null}}b.instance=null;const y=new b,x="csijs_",_=e=>0===e.indexOf(x)?e:x+e,v=(e,t,o)=>{"object"==typeof t&&(t=o?t:(e=>{try{return JSON.stringify(e)}catch(t){return e}})(t)),((e,t)=>{try{y.setItem(e,t)}catch(e){console.error(e)}})(_(e),t)},q=(e,t)=>{const o=(e=>y.getItem?y.getItem(e):null)(_(e));return o?t?o:(e=>{try{return JSON.parse(e)}catch(t){return e}})(o):null},L=e=>{(e=>{try{y&&y.removeItem(e)}catch(e){}})(_(e))},j=()=>{const e=q("info"),t=[],o=e?e.length:0;if(e&&o){const o=parseInt(e.max,10);for(let n=parseInt(e.min,10);n<=o;n++){const o=`${e.type}_${n}`,i=q(o);t.push(i)}}return t};function $(e){this.csiReport=e}function S(e){this.csi=e,this.tapQueue=[]}$.prototype.createPage=function(){const t=j();w(t)?s.fire({title:"暂无异常",text:"稍后窗口会自动关闭",icon:"success",heightAuto:!1,timer:2e3}):s.fire({title:"收集完成",text:`收集到${t.length}条日志，点击下方按钮下载日志`,icon:"success",heightAuto:!1,showConfirmButton:!0,confirmButtonText:"下载",showCancelButton:!0,cancelButtonText:"关闭",preConfirm:()=>{const t=j().map((e=>`${JSON.stringify(e,null,2)}\n`));var o=new Blob(t,{type:"text/plain;charset=utf-8"});i.saveAs(o,`${e.nanoid()}.dat`)}})},$.prototype.toggleShow=function(){s.isVisible()||this.createPage()},S.prototype={init(e=!1){this.showPage=new $(this.csi.report.bind(this.csi)),e||this.bindDefaultTrigger()},onTapQueue(e,t){const o=this.tapQueue.length?this.tapQueue[this.tapQueue.length-1]:null;if(o&&e.timeStamp-o.timeStamp>300&&(console.log("clear tap queue"),this.tapQueue=[]),this.tapQueue.push(e),this.tapQueue.length===t)return this.tapQueue=[],!0}},S.prototype.bindDefaultTrigger=function(){document.querySelector("html").addEventListener("touchend",(e=>{this.onTapQueue(e,4)&&setTimeout(this.toggleShow.bind(this),100)})),document.addEventListener("keydown",(e=>{(e=e||window.event).ctrlKey&&6===parseInt(e.key,10)&&this.showPage.toggleShow()}))},S.prototype.toggleShow=function(){this.showPage.toggleShow()};const k=function(e){this.forms=e};k.prototype.probe=function(){const{onerror:e}=window;window.onerror=(...t)=>{var o,n,i,s,r,a;"function"==typeof e&&e.apply(this,t),o=this.forms,n=t[0],i=t[1],s=t[2],r=t[3],a=t[4],o.addLine({etype:"win error",msg:`${n} \n ${a&&a.stack}`,js:`${i}:${s}:${r}`})}};const O={},I=function(e){this.forms=e},T=(e,t,o)=>{e.addLine({etype:"ajax error",msg:t,js:o.join(" :")})};I.prototype.probe=function(t=!1){const o=this;this.logAjaxTrace=t;const{open:n,send:i,setRequestHeader:s}=XMLHttpRequest.prototype;XMLHttpRequest.prototype.open=function(){const t=e.nanoid();this.__xhrid=t,o.addListener(this,arguments),n.apply(this,arguments)},XMLHttpRequest.prototype.setRequestHeader=function(){const[e,t]=[...arguments];"content-type"===e.toLowerCase()&&"application/json"===t.toLowerCase()&&(O[this.__xhrid].recordPayload=!0),s.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){O[this.__xhrid].recordPayload&&(O[this.__xhrid].payload=[...arguments]),i.apply(this,arguments)}},I.prototype.addListener=function(e,t){if(O[e.__xhrid])return;O[e.__xhrid]={xhr:e};const{ontimeout:o}=e;e.addEventListener("loadend",(()=>{const o=e.status;let n,i=O[e.__xhrid].payload||{};try{i=JSON.parse(i)}catch(e){i=i}try{n=JSON.parse(e.response)}catch(t){n=e.response}const s={status:o,payload:i,response:n};0!==parseInt(o)&&(/^2[0-9]{1,3}/gi.test(o)?this.logAjaxTrace&&((e,t,o)=>{e.addLine({etype:"ajax trace",msg:t,js:o.join(":")})})(this.forms,s,[...t]):T(this.forms,s,[...t]))})),e.addEventListener("error",(()=>{T(this.forms,e.status||"networkError",[...t])})),e.ontimeout=(...n)=>{this.forms.addLine({etype:"ajax error",msg:`timeout ${e.status}`,js:t.join(" :")}),o&&o.apply(this,n)}};const P=function(e){this.forms=e};P.prototype.probe=function(){if(!window.fetch)return;const e=window.fetch;window.fetch=(t,o)=>{let n="GET",i=t||"";return"string"==typeof t?n=o&&o.method?o.method:n:"[object Request]"===Object.prototype.toString.call(t)&&(n=t.method||n,i=t.url||""),e(t,o).then((e=>{const t=`${e.status}`;return/^2[0-9]{1,3}/gi.test(t)||0==+t||this.forms.addLine({etype:"fetch error",msg:`status:${e.status}`,js:`${n} :${i}`}),e})).catch((e=>{let t;try{t=e&&e.message?e.message:JSON.stringify(e)}catch(o){t=e&&e.message?e.message:e}throw this.forms.addLine({etype:"fetch error",msg:t,js:`${n} :${i}`}),e}))}};const Q=function(){this.fid="",this.uid="",this.min=0,this.max=0,this.type="",this.length=""},A=function(){this.pid="",this.index="",this.time="",this.ua="",this.etype="",this.msg="",this.url="",this.other=""},E=function(e,t,o){const n={feid:e,uid:g(),min:0,max:0,type:t,length:0};this.maxLine=o||20,this.info=m(new Q,n,q("info")),this.line=new A};E.prototype={addLine(e){const t={pid:g(6),index:parseInt(this.info.max,10)+1,time:Date.now(),ua:l()};(e=>{for(const t in e)e[t]="";e.url=location?location.href:""})(this.line),m(this.line,t,e);const o=`${this.info.type}_${this.line.index}`;v(o,this.line),this.updateInfo(this.line)},updateInfo(e){const t=parseInt(e.index,10);let o=parseInt(this.info.min,10);o=o||t;let n=t-o+1;if(n>this.maxLine){const e=n-this.maxLine;for(let t=0;t<e;t++){const e=`${this.info.type}_${o+t}`;L(e)}n=this.maxLine}this.info.length=n,this.info.min=t-n+1,this.info.max=t,v("info",this.info)}};const R=function(e,t){this.errTable=new E(e,"err",t)};R.prototype={addLine(e){const t=this.errTable;setTimeout((()=>{t.addLine(e)}),0)}};const C=()=>{l();const{browser:e}=f,{name:t}=e,o=parseFloat(e.version);return"ie"===t&&o<9};return class{constructor(e={}){e.report=e.report||(()=>{console.warn("report needs to be defined")}),this.inited=!1,this.checkParams(e),this.init(e)}checkParams(e){if(!e.feID)throw Error("feID必传");if(!e.report||"function"!=typeof e.report)throw Error("请填写自定义上报函数")}init(e){if(!this.inited&&!C())try{this.opts=e;const t=new R(e.feID,e.maxLine);this.forms=t,this.panel=new S(this),this.panel.init(e.customPanelTrigger),new k(t).probe(),new I(t).probe(e.logAjaxTrace),new P(t).probe(),this.inited=!0}catch(e){console.error(e)}}probe(...e){C()||this.forms.addLine({etype:"custom error",msg:e})}report(){if(C())return;const e=j();w(e)||this.opts.report(e)}showPanel(){this.panel.toggleShow()}}}));
