!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("nanoid"),require("file-saver"),require("sweetalert2"),require("axios"),require("ali-oss"),require("clipboard"),require("toastify-js")):"function"==typeof define&&define.amd?define(["nanoid","file-saver","sweetalert2","axios","ali-oss","clipboard","toastify-js"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).Mara=e(t.nanoid,t.FileSaver,t.Swal,t.axios,t.OSS,t.Clipboard,t.Toastify)}(this,(function(t,e,o,n,i,s,r){"use strict";function a(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var c=a(e),p=a(o),h=a(n),u=a(i),l=a(s),d=a(r);let f;const m={qq:/\bm?qqbrowser\/([0-9.]+)/,360:t=>-1!==t.indexOf("360 aphone browser")?/\b360 aphone browser \(([^\)]+)\)/:/\b360(?:se|ee|chrome|browser)\b/,aoyou:/\baoyou/,webview:/\bcpu(?: iphone)? os (?:[0-9._]+).+\bapplewebkit\b/,firefox:/\bfirefox\/([0-9.ab]+)/,chrome:/ (?:chrome|crios|crmo)\/([0-9.]+)/,ie:/\b(?:msie |ie |trident\/[0-9].*rv[ :])([0-9.]+)/,android:t=>-1===t.indexOf("android")?"":/\bversion\/([0-9.]+(?: beta)?)/,safari:/\bversion\/([0-9.]+(?: beta)?)(?: mobile(?:\/[a-z0-9]+)?)? safari\//,opera:/\bopera/,unknow:"unknow"},w={windows:/\bwindows nt ([0-9.]+)/,macosx:/\bmac os x ([0-9._]+)/,linux:"linux",wphone:t=>-1!==t.indexOf("windows phone ")?/\bwindows phone (?:os )?([0-9.]+)/:-1!==t.indexOf("xblwp")?/\bxblwp([0-9.]+)/:-1!==t.indexOf("zunewp")?/\bzunewp([0-9.]+)/:"windows phone",ios:t=>/\bcpu(?: iphone)? os /.test(t)?/\bcpu(?: iphone)? os ([0-9._]+)/:-1!==t.indexOf("iph os ")?/\biph os ([0-9_]+)/:/\bios\b/,android:t=>t.indexOf("android")>=0?/\bandroid[ \/-]?([0-9.x]+)?/:t.indexOf("adr")>=0?t.indexOf("mqqbrowser")>=0?/\badr[ ]\(linux; u; ([0-9.]+)?/:/\badr(?:[ ]([0-9.]+))?/:"android",unknow:"unknow"},g={weixin:/micromessenger/gi,qqvideo:/qqlivebrowser/gi,qqvideoipad:/qqlivehdbrowser/gi,shouqq:/qq\//gi,qqnews:/qqnews/gi,qzone:/qzone\//gi,unknow:"unknow"},b=(t,e)=>Object.prototype.toString.call(t)===`[object ${e}]`,y=(t,e)=>{const o=q[t.toLowerCase()];for(const t in e){const n=e[t],i=b(n,"Function")?n(x()):n;if(o.name=t,!0===i)break;if("[object String]"===toString(i)){if(-1!==x().indexOf(i))break}else if(b(i,"Object")){if(void 0!==i.version){o.version=i.version;break}}else if(i&&i.exec){const t=i.exec(x());if(t){t.length>=2&&t[1]?o.version=t[1].replace(/_/g,"."):o.version="0.0.0";break}}}return o},x=()=>{if(!f){const t="__",e=navigator.userAgent||"",o=navigator.platform||"",n=navigator.appVersion||"",i=navigator.vendor||"";f=e+t+o+t+n+t+i,f=f.toLowerCase()}return f},v=t=>{f||(y("os",w),y("platform",g),y("browser",m));return"all"===t||"full"===t?x():void 0!==t?q[t].name:`${q.os.name}  _${q.os.version}  ${q.browser.name}  _${q.browser.version}`},q={os:{name:"unknow",version:"0.0.0"},platform:{name:"unknow",version:"0.0.0"},browser:{name:"unknow",version:"0.0.0"}},_=(...t)=>{const e=t[0],o=Array.prototype.slice.call(t,1);for(let t=0;t<o.length;t++){const n=o[t];for(const t in n)e[t]=n[t]}return e},S=t=>{if(!t)return!0;if(!t.length)return!0;let e=0;for(let o=t.length-1;o>0;o--)t[o]||(e+=1);return e>t.length-1},j=t=>{const e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";t=t||9;let o="";for(let n=0;n<t;n++)o+=e.charAt(Math.floor(Math.random()*e.length));return o};class ${constructor(){if($.instance)return $.instance;this.__pool__={},$.instance=this}setItem(t,e){this.__pool__[t]=e}getItem(t){return this.__pool__[t]}remove(t){this.__pool__[t]=null}}$.instance=null;const L=new $,k="csijs_",T=t=>0===t.indexOf(k)?t:k+t,O=(t,e,o)=>{"object"==typeof e&&(e=o?e:(t=>{try{return JSON.stringify(t)}catch(e){return t}})(e)),((t,e)=>{try{L.setItem(t,e)}catch(t){console.error(t)}})(T(t),e)},I=(t,e)=>{const o=(t=>L.getItem?L.getItem(t):null)(T(t));return o?e?o:(t=>{try{return JSON.parse(t)}catch(e){return t}})(o):null},A=t=>{(t=>{try{L&&L.removeItem(t)}catch(t){}})(T(t))},C=()=>{const t=I("info"),e=[],o=t?t.length:0;if(t&&o){const o=parseInt(t.max,10);for(let n=parseInt(t.min,10);n<=o;n++){const o=`${t.type}_${n}`,i=I(o);e.push(i)}}return e},B={download:"下载",copy:"复制",upload:"上传",report:"上报"};function z(t,e="download"){this.csiReport=t,B[e]&&(this.operation=e,this.mainBtnText=B[e])}function P(t){this.csi=t,this.tapQueue=[]}z.prototype.createPage=function(){const e=C();S(e)?p.fire({title:"暂无异常",text:"稍后窗口会自动关闭",icon:"success",heightAuto:!1,timer:2e3}):p.fire({title:"收集完成",text:`收集到${e.length}条日志，点击下方按钮下载日志`,icon:"success",heightAuto:!1,showConfirmButton:!0,confirmButtonText:this.mainBtnText,showCancelButton:!0,cancelButtonText:"关闭",preConfirm:()=>"upload"===this.operation?(async()=>{const e=C().map((t=>`${JSON.stringify(t,null,2)}\n`));var o=new Blob(e,{type:"text/plain;charset=utf-8"});const n=`${t.nanoid()}.dat`,{Credentials:i}=(await h({method:"get",url:"http://julianos-uat.longfor.com/api/admin/alioss/sts",withCredentials:!0})).data,s=new u({region:"oss-cn-beijing",accessKeyId:i.AccessKeyId,accessKeySecret:i.AccessKeySecret,stsToken:i.SecurityToken,bucket:"prod-zws-wuguofeng"});await s.put(`mara/${n}`,o);const r=await s.signatureUrl(`mara/${n}`);p.fire({title:"上传完成",icon:"success",showConfirmButton:!0,confirmButtonText:"复制链接",showCancelButton:!0,cancelButtonText:"关闭",preConfirm:()=>{document.querySelector(".swal2-confirm").setAttribute("data-clipboard-text",r),new l(".swal2-confirm").on("success",(function(t){console.log(t),d({text:"链接已复制",duration:1e3,gravity:"bottom",position:"center",style:{position:"fixed",margin:"0 auto",left:0,right:0,width:"80px",textAlign:"center",background:"black",zIndex:"999999",padding:"5px",opacity:.8,borderRadius:"5px",color:"white"}}).showToast(),t.clearSelection()}))}})})():"copy"===this.operation?(()=>{const t=JSON.stringify(C(),null,2);document.querySelector(".swal2-confirm").setAttribute("data-clipboard-text",t),new l(".swal2-confirm").on("success",(function(t){d({text:"复制成功",duration:1e3,gravity:"bottom",position:"center",style:{position:"fixed",margin:"0 auto",left:0,right:0,width:"80px",textAlign:"center",background:"black",zIndex:"999999",padding:"5px",opacity:.8,borderRadius:"5px",color:"white"}}).showToast(),t.clearSelection()}))})():(()=>{const e=C().map((t=>`${JSON.stringify(t,null,2)}\n`));var o=new Blob(e,{type:"text/plain;charset=utf-8"});const n=`${t.nanoid()}.dat`;c.saveAs(o,n)})()})},z.prototype.toggleShow=function(){p.isVisible()||this.createPage()},P.prototype={init(t=!1,e){this.showPage=new z(this.csi.report.bind(this.csi),e),t||this.bindDefaultTrigger()},onTapQueue(t,e){const o=this.tapQueue.length?this.tapQueue[this.tapQueue.length-1]:null;if(o&&t.timeStamp-o.timeStamp>300&&(console.log("clear tap queue"),this.tapQueue=[]),this.tapQueue.push(t),this.tapQueue.length===e)return this.tapQueue=[],!0}},P.prototype.bindDefaultTrigger=function(){document.querySelector("html").addEventListener("touchend",(t=>{this.onTapQueue(t,4)&&setTimeout(this.toggleShow.bind(this),100)})),document.addEventListener("keydown",(t=>{(t=t||window.event).ctrlKey&&6===parseInt(t.key,10)&&this.showPage.toggleShow()}))},P.prototype.toggleShow=function(){this.showPage.toggleShow()};const Q=function(t){this.forms=t};Q.prototype.probe=function(){const{onerror:t}=window;window.onerror=(...e)=>{var o,n,i,s,r,a;"function"==typeof t&&t.apply(this,e),o=this.forms,n=e[0],i=e[1],s=e[2],r=e[3],a=e[4],o.addLine({etype:"win error",msg:`${n} \n ${a&&a.stack}`,js:`${i}:${s}:${r}`})}};const R={},E=function(t){this.forms=t},J=(t,e,o)=>{t.addLine({etype:"ajax error",msg:e,js:o.join(" :")})};E.prototype.probe=function(e=!1){const o=this;this.logAjaxTrace=e;const{open:n,send:i,setRequestHeader:s}=XMLHttpRequest.prototype;XMLHttpRequest.prototype.open=function(){const e=t.nanoid();this.__xhrid=e,o.addListener(this,arguments),n.apply(this,arguments)},XMLHttpRequest.prototype.setRequestHeader=function(){const[t,e]=[...arguments];"content-type"===t.toLowerCase()&&"application/json"===e.toLowerCase()&&(R[this.__xhrid].recordPayload=!0),s.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){R[this.__xhrid].recordPayload&&(R[this.__xhrid].payload=[...arguments]),i.apply(this,arguments)}},E.prototype.addListener=function(t,e){if(R[t.__xhrid])return;R[t.__xhrid]={xhr:t};const{ontimeout:o}=t;t.addEventListener("loadend",(()=>{const o=t.status;let n,i=R[t.__xhrid].payload||{};try{i=JSON.parse(i)}catch(t){i=i}try{n=JSON.parse(t.response)}catch(e){n=t.response}const s={status:o,payload:i,response:n};0!==parseInt(o)&&(/^2[0-9]{1,3}/gi.test(o)?this.logAjaxTrace&&((t,e,o)=>{t.addLine({etype:"ajax trace",msg:e,js:o.join(":")})})(this.forms,s,[...e]):J(this.forms,s,[...e]))})),t.addEventListener("error",(()=>{J(this.forms,t.status||"networkError",[...e])})),t.ontimeout=(...n)=>{this.forms.addLine({etype:"ajax error",msg:`timeout ${t.status}`,js:e.join(" :")}),o&&o.apply(this,n)}};const M=function(t){this.forms=t};M.prototype.probe=function(){if(!window.fetch)return;const t=window.fetch;window.fetch=(e,o)=>{let n="GET",i=e||"";return"string"==typeof e?n=o&&o.method?o.method:n:"[object Request]"===Object.prototype.toString.call(e)&&(n=e.method||n,i=e.url||""),t(e,o).then((t=>{const e=`${t.status}`;return/^2[0-9]{1,3}/gi.test(e)||0==+e||this.forms.addLine({etype:"fetch error",msg:`status:${t.status}`,js:`${n} :${i}`}),t})).catch((t=>{let e;try{e=t&&t.message?t.message:JSON.stringify(t)}catch(o){e=t&&t.message?t.message:t}throw this.forms.addLine({etype:"fetch error",msg:e,js:`${n} :${i}`}),t}))}};const N=function(){this.fid="",this.uid="",this.min=0,this.max=0,this.type="",this.length=""},D=function(){this.pid="",this.index="",this.time="",this.ua="",this.etype="",this.msg="",this.url="",this.other=""},H=function(t,e,o){const n={feid:t,uid:j(),min:0,max:0,type:e,length:0};this.maxLine=o||20,this.info=_(new N,n,I("info")),this.line=new D};H.prototype={addLine(t){const e={pid:j(6),index:parseInt(this.info.max,10)+1,time:Date.now(),ua:v()};(t=>{for(const e in t)t[e]="";t.url=location?location.href:""})(this.line),_(this.line,e,t);const o=`${this.info.type}_${this.line.index}`;O(o,this.line),this.updateInfo(this.line)},updateInfo(t){const e=parseInt(t.index,10);let o=parseInt(this.info.min,10);o=o||e;let n=e-o+1;if(n>this.maxLine){const t=n-this.maxLine;for(let e=0;e<t;e++){const t=`${this.info.type}_${o+e}`;A(t)}n=this.maxLine}this.info.length=n,this.info.min=e-n+1,this.info.max=e,O("info",this.info)}};const F=function(t,e){this.errTable=new H(t,"err",e)};F.prototype={addLine(t){const e=this.errTable;setTimeout((()=>{e.addLine(t)}),0)}};const K=()=>{v();const{browser:t}=q,{name:e}=t,o=parseFloat(t.version);return"ie"===e&&o<9};return class{constructor(t={}){t.report=t.report||(()=>{console.warn("report needs to be defined")}),this.inited=!1,this.checkParams(t),this.init(t)}checkParams(t){if(!t.feID)throw Error("feID必传");if(!t.report||"function"!=typeof t.report)throw Error("请填写自定义上报函数")}init(t){if(!this.inited&&!K()){try{this.opts=t;const e=new F(t.feID,t.maxLine);this.forms=e,this.panel=new P(this),this.panel.init(t.customPanelTrigger,t.operationMethod),new Q(e).probe(),new E(e).probe(t.logAjaxTrace),new M(e).probe(),this.inited=!0}catch(t){console.error(t)}if(t.containerFontSize){const e=document.createElement("style");e.innerText=`.swal2-popup {font-size: ${t.containerFontSize}}`,document.head.appendChild(e)}}}probe(...t){K()||this.forms.addLine({etype:"custom error",msg:t})}report(){if(K())return;const t=C();S(t)||this.opts.report(t)}showPanel(){this.panel.toggleShow()}}}));
