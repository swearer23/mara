!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("crypto-js"),require("nanoid"),require("file-saver"),require("sweetalert2"),require("axios"),require("ali-oss"),require("clipboard"),require("toastify-js")):"function"==typeof define&&define.amd?define(["crypto-js","nanoid","file-saver","sweetalert2","axios","ali-oss","clipboard","toastify-js"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).Mara=e(t.CryptoJS,t.nanoid,t.FileSaver,t.Swal,t.axios,t.OSS,t.Clipboard,t.Toastify)}(this,(function(t,e,o,i,n,s,r,a){"use strict";function c(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var p=c(t),d=c(o),h=c(i),u=c(n),l=c(s),f=c(r),g=c(a);class m{constructor(t,e){if(m.instance)return m.instance;this.__pool__=[],this.feid=t,this.maxLine=parseInt(e)||20,m.instance=this}addLine(t){this.__pool__.length>=this.maxLine&&this.__pool__.shift(),this.__pool__.push(Object.assign({feid:this.feid},t))}readLines(){return this.__pool__}}m.instance=null;const y=()=>m.instance.readLines();let w=null;const x={download:"下载",upload:"上传"};function b(t,e){this.operation=e.operationMethod||"download",this.mainBtnText=x[this.operation],this.csiReport=t,this.env=e.env||"prod",this.appid=e.appid,this.appname=e.feID}const _=async(t,o,i)=>{const n=y().map((t=>`${JSON.stringify(t,null,2)}\n`)),s=new Blob(n,{type:"text/plain;charset=utf-8"}),r=`${e.nanoid()}.dat`,a=(new Date).getTime(),c=(t=>{const e=t=>t>=65&&t<91||t>=97&&t<123,o=t.toString().split("");let i="",n=0;for(;n<13;){const t=o[n],s=`${t}${o[n+1]}`,r=`${s}${o[n+2]}`;0!==parseInt(t)?e(parseInt(s))?(i+=String.fromCharCode(s),n+=2):e(parseInt(r))?(i+=String.fromCharCode(r),n+=3):(i+=t,n++):(i=`${i}${t}`,n++)}return i.split("").reverse().join("")})(a),d=((t,e)=>p.MD5(`${t}${e}`).toString())(o,a);let m,x,b,_;"prod"===t?(m="https://m7-hlgw-c1-openapi.longfor.com/julianos-prod/",_="a2e33eb4-6516-43f9-bcc0-9c47b0f123b3"):(m="//api-uat.longfor.com/julianos-uat/",_="791f6690-0714-445f-9273-78a3199622d2");const S={"X-Gaia-Api-Key":_};o?(x="api/mara/alioss/sts",S["x-mara-signature"]=d,S["x-mara-slug"]=c,S["x-mara-app-name"]=i):x="api/admin/alioss/sts",b=`${m}${x}`;const{Credentials:$}=(await u({method:"get",url:b,withCredentials:!0,headers:S})).data,j=new l({region:"oss-cn-beijing",accessKeyId:$.AccessKeyId,accessKeySecret:$.AccessKeySecret,stsToken:$.SecurityToken,bucket:"prod-zws-wuguofeng"});await j.put(`mara/${r}`,s);const L=await j.signatureUrl(`mara/${r}`);h.fire({title:"上传完成",icon:"success",showConfirmButton:!0,confirmButtonText:"复制链接",showCancelButton:!0,cancelButtonText:"关闭",preConfirm:()=>{document.querySelector(".swal2-confirm").setAttribute("data-clipboard-text",L),w&&w.destroy(),w=new f(".swal2-confirm"),w.on("success",(function(t){console.log(t),g({text:"链接已复制",duration:1e3,gravity:"bottom",position:"center",style:{position:"fixed",margin:"0 auto",left:0,right:0,width:"80px",textAlign:"center",background:"black",zIndex:"999999",padding:"5px",opacity:.8,borderRadius:"5px",color:"white"}}).showToast(),t.clearSelection()}))}})};function S(t){this.csi=t,this.tapQueue=[]}b.prototype.createPage=function(){const t=y();t.length?h.fire({title:"收集完成",text:`收集到${t.length}条日志，点击下方按钮下载日志`,icon:"success",heightAuto:!1,showConfirmButton:!0,confirmButtonText:this.mainBtnText,showCancelButton:!0,cancelButtonText:"关闭",preConfirm:()=>"upload"===this.operation?_(this.env,this.appid,this.appname):"copy"===this.operation?(()=>{const t=JSON.stringify(y(),null,2);document.querySelector(".swal2-confirm").setAttribute("data-clipboard-text",t),w&&w.destroy(),w=new f(".swal2-confirm"),w.on("success",(function(t){g({text:"复制成功",duration:1e3,gravity:"bottom",position:"center",style:{position:"fixed",margin:"0 auto",left:0,right:0,width:"80px",textAlign:"center",background:"black",zIndex:"999999",padding:"5px",opacity:.8,borderRadius:"5px",color:"white"}}).showToast(),t.clearSelection()}))})():(()=>{const t=y().map((t=>`${JSON.stringify(t,null,2)}\n`));var o=new Blob(t,{type:"text/plain;charset=utf-8"});const i=`${e.nanoid()}.dat`;d.saveAs(o,i)})()}):h.fire({title:"暂无异常",text:"稍后窗口会自动关闭",icon:"success",heightAuto:!1,timer:2e3})},b.prototype.toggleShow=function(){h.isVisible()||this.createPage()},S.prototype={init(t){this.showPage=new b(this.csi.report.bind(this.csi),t),t.customPanelTrigger||this.bindDefaultTrigger()},onTapQueue(t,e){const o=this.tapQueue.length?this.tapQueue[this.tapQueue.length-1]:null;if(o&&t.timeStamp-o.timeStamp>300&&(this.tapQueue=[]),this.tapQueue.push(t),this.tapQueue.length===e)return this.tapQueue=[],!0}},S.prototype.bindDefaultTrigger=function(){document.querySelector("html").addEventListener("touchend",(t=>{this.onTapQueue(t,4)&&setTimeout(this.toggleShow.bind(this),100)})),document.addEventListener("keydown",(t=>{(t=t||window.event).ctrlKey&&6===parseInt(t.key,10)&&this.showPage.toggleShow()}))},S.prototype.toggleShow=function(){this.showPage.toggleShow()};const $=function(t){this.forms=t};$.prototype.probe=function(){const{onerror:t}=window;window.onerror=(...e)=>{var o,i,n,s,r,a;"function"==typeof t&&t.apply(this,e),o=this.forms,i=e[0],n=e[1],s=e[2],r=e[3],a=e[4],o.addLine({etype:"JS_ERROR",msg:`${i} \n ${a&&a.stack}`,js:`${n}:${s}:${r}`})}};const j={},L=function(t){this.forms=t},T=(t,e,o)=>{t.addLine({etype:"XHR_ERROR",msg:e,js:o.join(" :")})};L.prototype.probe=function(t=!1,o){const i=this;this.logAjaxTrace=t,this.excludeKeywords=o||[];const{open:n,send:s,setRequestHeader:r}=XMLHttpRequest.prototype,a=t=>{for(let e=0;e<this.excludeKeywords.length;e++)if(-1!==t.indexOf(this.excludeKeywords[e]))return!0;return!1};XMLHttpRequest.prototype.open=function(){const t=[...arguments];if(t[1]&&a(t[1]))return n.apply(this,arguments);const o=e.nanoid();this.__xhrid=o,i.addListener(this,arguments),n.apply(this,arguments)},XMLHttpRequest.prototype.setRequestHeader=function(){if(!this.__xhrid)return r.apply(this,arguments);const[t,e]=[...arguments];"content-type"===t.toLowerCase()&&e.toLowerCase().includes("application/json")&&(j[this.__xhrid].recordPayload=!0),r.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){if(!this.__xhrid)return s.apply(this,arguments);j[this.__xhrid].recordPayload&&(j[this.__xhrid].payload=[...arguments]),s.apply(this,arguments)}},L.prototype.addListener=function(t,e){if(j[t.__xhrid])return;j[t.__xhrid]={xhr:t};const{ontimeout:o}=t;t.addEventListener("loadend",(()=>{const o=t.status;let i,n=j[t.__xhrid].payload||{};try{n=JSON.parse(n)}catch(t){n=n}try{i=JSON.parse(t.response)}catch(e){i=t.response}const s={status:o,payload:n,response:i};0!==parseInt(o)&&(/^2[0-9]{1,3}/gi.test(o)?this.logAjaxTrace&&((t,e,o)=>{t.addLine({etype:"XHR_TRACE",msg:e,js:o.join(":")})})(this.forms,s,[...e]):T(this.forms,s,[...e]))})),t.addEventListener("error",(()=>{T(this.forms,t.status||"networkError",[...e])})),t.ontimeout=(...i)=>{this.forms.addLine({etype:"ajax error",msg:`timeout ${t.status}`,js:e.join(" :")}),o&&o.apply(this,i)}};const v=function(t){this.forms=t};v.prototype.probe=function(){if(!window.fetch)return;const t=window.fetch;window.fetch=(e,o)=>{let i="GET",n=e||"";return"string"==typeof e?i=o&&o.method?o.method:i:"[object Request]"===Object.prototype.toString.call(e)&&(i=e.method||i,n=e.url||""),t(e,o).then((t=>{const e=`${t.status}`;return/^2[0-9]{1,3}/gi.test(e)||0==+e||this.forms.addLine({etype:"fetch error",msg:`status:${t.status}`,js:`${i} :${n}`}),t})).catch((t=>{let e;try{e=t&&t.message?t.message:JSON.stringify(t)}catch(o){e=t&&t.message?t.message:t}throw this.forms.addLine({etype:"fetch error",msg:e,js:`${i} :${n}`}),t}))}};const C=function(t,e){this.storage=new m(t,e)};C.prototype={addLine(t){const o={pid:e.nanoid(),time:Date.now(),ua:navigator.userAgent,url:location?location.href:""};setTimeout((()=>{this.storage.addLine(Object.assign(o,t))}),0)}};return class{constructor(t={}){t.report=t.report||(()=>{console.warn("report needs to be defined")}),t.operationMethod=t.operationMethod||"download",this.inited=!1;try{this.checkParams(t),this.init(t)}catch(t){console.error(t)}}checkParams(t){if(!t.feID)throw Error("feID必传");if(!["download","upload"].includes(t.operationMethod)){const e=[`mara warning: the operationMethod ${t.operationMethod} is not supported`,"please select from either 'download' or 'upload'"];throw Error(e.join("\n"))}}init(t){try{this.opts=t;const e=new C(t.feID,t.maxLine);this.forms=e,this.panel=new S(this),this.panel.init(t),new $(e).probe(),new L(e).probe(t.logAjaxTrace,t.excludeAjaxKeywords),new v(e).probe(),this.inited=!0}catch(t){console.error(t)}if(t.containerFontSize){const e=document.createElement("style");e.innerText=`.swal2-popup {font-size: ${t.containerFontSize}}`,document.head.appendChild(e)}}probe(...t){this.forms.addLine({etype:"CUSTOM_LOG",msg:t})}report(){const t=y();t.length&&this.opts.report(t)}showPanel(){this.panel.toggleShow()}}}));
