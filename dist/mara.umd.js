!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("nanoid"),require("file-saver"),require("sweetalert2"),require("axios"),require("ali-oss"),require("clipboard"),require("toastify-js")):"function"==typeof define&&define.amd?define(["nanoid","file-saver","sweetalert2","axios","ali-oss","clipboard","toastify-js"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).Mara=t(e.nanoid,e.FileSaver,e.Swal,e.axios,e.OSS,e.Clipboard,e.Toastify)}(this,(function(e,t,o,n,i,s,r){"use strict";function a(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var c=a(t),p=a(o),h=a(n),u=a(i),d=a(s),l=a(r);let f;const m={qq:/\bm?qqbrowser\/([0-9.]+)/,360:e=>-1!==e.indexOf("360 aphone browser")?/\b360 aphone browser \(([^\)]+)\)/:/\b360(?:se|ee|chrome|browser)\b/,aoyou:/\baoyou/,webview:/\bcpu(?: iphone)? os (?:[0-9._]+).+\bapplewebkit\b/,firefox:/\bfirefox\/([0-9.ab]+)/,chrome:/ (?:chrome|crios|crmo)\/([0-9.]+)/,ie:/\b(?:msie |ie |trident\/[0-9].*rv[ :])([0-9.]+)/,android:e=>-1===e.indexOf("android")?"":/\bversion\/([0-9.]+(?: beta)?)/,safari:/\bversion\/([0-9.]+(?: beta)?)(?: mobile(?:\/[a-z0-9]+)?)? safari\//,opera:/\bopera/,unknow:"unknow"},w={windows:/\bwindows nt ([0-9.]+)/,macosx:/\bmac os x ([0-9._]+)/,linux:"linux",wphone:e=>-1!==e.indexOf("windows phone ")?/\bwindows phone (?:os )?([0-9.]+)/:-1!==e.indexOf("xblwp")?/\bxblwp([0-9.]+)/:-1!==e.indexOf("zunewp")?/\bzunewp([0-9.]+)/:"windows phone",ios:e=>/\bcpu(?: iphone)? os /.test(e)?/\bcpu(?: iphone)? os ([0-9._]+)/:-1!==e.indexOf("iph os ")?/\biph os ([0-9_]+)/:/\bios\b/,android:e=>e.indexOf("android")>=0?/\bandroid[ \/-]?([0-9.x]+)?/:e.indexOf("adr")>=0?e.indexOf("mqqbrowser")>=0?/\badr[ ]\(linux; u; ([0-9.]+)?/:/\badr(?:[ ]([0-9.]+))?/:"android",unknow:"unknow"},g={weixin:/micromessenger/gi,qqvideo:/qqlivebrowser/gi,qqvideoipad:/qqlivehdbrowser/gi,shouqq:/qq\//gi,qqnews:/qqnews/gi,qzone:/qzone\//gi,unknow:"unknow"},y=(e,t)=>Object.prototype.toString.call(e)===`[object ${t}]`,b=(e,t)=>{const o=v[e.toLowerCase()];for(const e in t){const n=t[e],i=y(n,"Function")?n(x()):n;if(o.name=e,!0===i)break;if("[object String]"===toString(i)){if(-1!==x().indexOf(i))break}else if(y(i,"Object")){if(void 0!==i.version){o.version=i.version;break}}else if(i&&i.exec){const e=i.exec(x());if(e){e.length>=2&&e[1]?o.version=e[1].replace(/_/g,"."):o.version="0.0.0";break}}}return o},x=()=>{if(!f){const e="__",t=navigator.userAgent||"",o=navigator.platform||"",n=navigator.appVersion||"",i=navigator.vendor||"";f=t+e+o+e+n+e+i,f=f.toLowerCase()}return f},_=e=>{f||(b("os",w),b("platform",g),b("browser",m));return"all"===e||"full"===e?x():void 0!==e?v[e].name:`${v.os.name}  _${v.os.version}  ${v.browser.name}  _${v.browser.version}`},v={os:{name:"unknow",version:"0.0.0"},platform:{name:"unknow",version:"0.0.0"},browser:{name:"unknow",version:"0.0.0"}},q=(...e)=>{const t=e[0],o=Array.prototype.slice.call(e,1);for(let e=0;e<o.length;e++){const n=o[e];for(const e in n)t[e]=n[e]}return t},S=e=>{if(!e)return!0;if(!e.length)return!0;let t=0;for(let o=e.length-1;o>0;o--)e[o]||(t+=1);return t>e.length-1},j=e=>{const t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";e=e||9;let o="";for(let n=0;n<e;n++)o+=t.charAt(Math.floor(Math.random()*t.length));return o};class ${constructor(){if($.instance)return $.instance;this.__pool__={},$.instance=this}setItem(e,t){this.__pool__[e]=t}getItem(e){return this.__pool__[e]}remove(e){this.__pool__[e]=null}}$.instance=null;const L=new $,k="csijs_",T=e=>0===e.indexOf(k)?e:k+e,O=(e,t,o)=>{"object"==typeof t&&(t=o?t:(e=>{try{return JSON.stringify(e)}catch(t){return e}})(t)),((e,t)=>{try{L.setItem(e,t)}catch(e){console.error(e)}})(T(e),t)},I=(e,t)=>{const o=(e=>L.getItem?L.getItem(e):null)(T(e));return o?t?o:(e=>{try{return JSON.parse(e)}catch(t){return e}})(o):null},A=e=>{(e=>{try{L&&L.removeItem(e)}catch(e){}})(T(e))},C=()=>{const e=I("info"),t=[],o=e?e.length:0;if(e&&o){const o=parseInt(e.max,10);for(let n=parseInt(e.min,10);n<=o;n++){const o=`${e.type}_${n}`,i=I(o);t.push(i)}}return t},B={download:"下载",copy:"复制",upload:"上传",report:"上报"};function z(e,t="download",o="prod"){this.csiReport=e,this.env=o,B[t]&&(this.operation=t,this.mainBtnText=B[t])}function P(e){this.csi=e,this.tapQueue=[]}z.prototype.createPage=function(){const t=C();S(t)?p.fire({title:"暂无异常",text:"稍后窗口会自动关闭",icon:"success",heightAuto:!1,timer:2e3}):p.fire({title:"收集完成",text:`收集到${t.length}条日志，点击下方按钮下载日志`,icon:"success",heightAuto:!1,showConfirmButton:!0,confirmButtonText:this.mainBtnText,showCancelButton:!0,cancelButtonText:"关闭",preConfirm:()=>"upload"===this.operation?(async t=>{const o=C().map((e=>`${JSON.stringify(e,null,2)}\n`)),n=new Blob(o,{type:"text/plain;charset=utf-8"}),i=`${e.nanoid()}.dat`;let s,r;"prod"===t?(s="https://m7-hlgw-c1-openapi.longfor.com/julianos-prod/api/admin/alioss/sts",r="a2e33eb4-6516-43f9-bcc0-9c47b0f123b3"):(s="//api-uat.longfor.com/julianos-uat/api/admin/alioss/sts",r="791f6690-0714-445f-9273-78a3199622d2");const{Credentials:a}=(await h({method:"get",url:s,withCredentials:!0,headers:{"X-Gaia-Api-Key":r}})).data,c=new u({region:"oss-cn-beijing",accessKeyId:a.AccessKeyId,accessKeySecret:a.AccessKeySecret,stsToken:a.SecurityToken,bucket:"prod-zws-wuguofeng"});await c.put(`mara/${i}`,n);const f=await c.signatureUrl(`mara/${i}`);p.fire({title:"上传完成",icon:"success",showConfirmButton:!0,confirmButtonText:"复制链接",showCancelButton:!0,cancelButtonText:"关闭",preConfirm:()=>{document.querySelector(".swal2-confirm").setAttribute("data-clipboard-text",f),new d(".swal2-confirm").on("success",(function(e){console.log(e),l({text:"链接已复制",duration:1e3,gravity:"bottom",position:"center",style:{position:"fixed",margin:"0 auto",left:0,right:0,width:"80px",textAlign:"center",background:"black",zIndex:"999999",padding:"5px",opacity:.8,borderRadius:"5px",color:"white"}}).showToast(),e.clearSelection()}))}})})(this.env):"copy"===this.operation?(()=>{const e=JSON.stringify(C(),null,2);document.querySelector(".swal2-confirm").setAttribute("data-clipboard-text",e),new d(".swal2-confirm").on("success",(function(e){l({text:"复制成功",duration:1e3,gravity:"bottom",position:"center",style:{position:"fixed",margin:"0 auto",left:0,right:0,width:"80px",textAlign:"center",background:"black",zIndex:"999999",padding:"5px",opacity:.8,borderRadius:"5px",color:"white"}}).showToast(),e.clearSelection()}))})():(()=>{const t=C().map((e=>`${JSON.stringify(e,null,2)}\n`));var o=new Blob(t,{type:"text/plain;charset=utf-8"});const n=`${e.nanoid()}.dat`;c.saveAs(o,n)})()})},z.prototype.toggleShow=function(){p.isVisible()||this.createPage()},P.prototype={init(e=!1,t,o){this.showPage=new z(this.csi.report.bind(this.csi),t,o),e||this.bindDefaultTrigger()},onTapQueue(e,t){const o=this.tapQueue.length?this.tapQueue[this.tapQueue.length-1]:null;if(o&&e.timeStamp-o.timeStamp>300&&(this.tapQueue=[]),this.tapQueue.push(e),this.tapQueue.length===t)return this.tapQueue=[],!0}},P.prototype.bindDefaultTrigger=function(){document.querySelector("html").addEventListener("touchend",(e=>{this.onTapQueue(e,4)&&setTimeout(this.toggleShow.bind(this),100)})),document.addEventListener("keydown",(e=>{(e=e||window.event).ctrlKey&&6===parseInt(e.key,10)&&this.showPage.toggleShow()}))},P.prototype.toggleShow=function(){this.showPage.toggleShow()};const K=function(e){this.forms=e};K.prototype.probe=function(){const{onerror:e}=window;window.onerror=(...t)=>{var o,n,i,s,r,a;"function"==typeof e&&e.apply(this,t),o=this.forms,n=t[0],i=t[1],s=t[2],r=t[3],a=t[4],o.addLine({etype:"win error",msg:`${n} \n ${a&&a.stack}`,js:`${i}:${s}:${r}`})}};const Q={},R=function(e){this.forms=e},E=(e,t,o)=>{e.addLine({etype:"ajax error",msg:t,js:o.join(" :")})};R.prototype.probe=function(t=!1,o){const n=this;this.logAjaxTrace=t,this.excludeKeywords=o||[];const{open:i,send:s,setRequestHeader:r}=XMLHttpRequest.prototype,a=e=>{for(let t=0;t<this.excludeKeywords.length;t++)if(-1!==e.indexOf(this.excludeKeywords[t]))return!0;return!1};XMLHttpRequest.prototype.open=function(){const t=[...arguments];if(t[1]&&a(t[1]))return i.apply(this,arguments);const o=e.nanoid();this.__xhrid=o,n.addListener(this,arguments),i.apply(this,arguments)},XMLHttpRequest.prototype.setRequestHeader=function(){if(!this.__xhrid)return r.apply(this,arguments);const[e,t]=[...arguments];"content-type"===e.toLowerCase()&&t.toLowerCase().includes("application/json")&&(Q[this.__xhrid].recordPayload=!0),r.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){if(!this.__xhrid)return s.apply(this,arguments);Q[this.__xhrid].recordPayload&&(Q[this.__xhrid].payload=[...arguments]),s.apply(this,arguments)}},R.prototype.addListener=function(e,t){if(Q[e.__xhrid])return;Q[e.__xhrid]={xhr:e};const{ontimeout:o}=e;e.addEventListener("loadend",(()=>{const o=e.status;let n,i=Q[e.__xhrid].payload||{};try{i=JSON.parse(i)}catch(e){i=i}try{n=JSON.parse(e.response)}catch(t){n=e.response}const s={status:o,payload:i,response:n};0!==parseInt(o)&&(/^2[0-9]{1,3}/gi.test(o)?this.logAjaxTrace&&((e,t,o)=>{e.addLine({etype:"ajax trace",msg:t,js:o.join(":")})})(this.forms,s,[...t]):E(this.forms,s,[...t]))})),e.addEventListener("error",(()=>{E(this.forms,e.status||"networkError",[...t])})),e.ontimeout=(...n)=>{this.forms.addLine({etype:"ajax error",msg:`timeout ${e.status}`,js:t.join(" :")}),o&&o.apply(this,n)}};const J=function(e){this.forms=e};J.prototype.probe=function(){if(!window.fetch)return;const e=window.fetch;window.fetch=(t,o)=>{let n="GET",i=t||"";return"string"==typeof t?n=o&&o.method?o.method:n:"[object Request]"===Object.prototype.toString.call(t)&&(n=t.method||n,i=t.url||""),e(t,o).then((e=>{const t=`${e.status}`;return/^2[0-9]{1,3}/gi.test(t)||0==+t||this.forms.addLine({etype:"fetch error",msg:`status:${e.status}`,js:`${n} :${i}`}),e})).catch((e=>{let t;try{t=e&&e.message?e.message:JSON.stringify(e)}catch(o){t=e&&e.message?e.message:e}throw this.forms.addLine({etype:"fetch error",msg:t,js:`${n} :${i}`}),e}))}};const M=function(){this.fid="",this.uid="",this.min=0,this.max=0,this.type="",this.length=""},N=function(){this.pid="",this.index="",this.time="",this.ua="",this.etype="",this.msg="",this.url="",this.other=""},D=function(e,t,o){const n={feid:e,uid:j(),min:0,max:0,type:t,length:0};this.maxLine=o||20,this.info=q(new M,n,I("info")),this.line=new N};D.prototype={addLine(e){const t={pid:j(6),index:parseInt(this.info.max,10)+1,time:Date.now(),ua:_()};(e=>{for(const t in e)e[t]="";e.url=location?location.href:""})(this.line),q(this.line,t,e);const o=`${this.info.type}_${this.line.index}`;O(o,this.line),this.updateInfo(this.line)},updateInfo(e){const t=parseInt(e.index,10);let o=parseInt(this.info.min,10);o=o||t;let n=t-o+1;if(n>this.maxLine){const e=n-this.maxLine;for(let t=0;t<e;t++){const e=`${this.info.type}_${o+t}`;A(e)}n=this.maxLine}this.info.length=n,this.info.min=t-n+1,this.info.max=t,O("info",this.info)}};const H=function(e,t){this.errTable=new D(e,"err",t)};H.prototype={addLine(e){const t=this.errTable;setTimeout((()=>{t.addLine(e)}),0)}};const F=()=>{_();const{browser:e}=v,{name:t}=e,o=parseFloat(e.version);return"ie"===t&&o<9};return class{constructor(e={}){e.report=e.report||(()=>{console.warn("report needs to be defined")}),this.inited=!1,this.checkParams(e),this.init(e)}checkParams(e){if(!e.feID)throw Error("feID必传");if(!e.report||"function"!=typeof e.report)throw Error("请填写自定义上报函数")}init(e){if(!this.inited&&!F()){try{this.opts=e;const t=new H(e.feID,e.maxLine);this.forms=t,this.panel=new P(this),this.panel.init(e.customPanelTrigger,e.operationMethod,e.env),new K(t).probe(),new R(t).probe(e.logAjaxTrace,e.excludeAjaxKeywords),new J(t).probe(),this.inited=!0}catch(e){console.error(e)}if(e.containerFontSize){const t=document.createElement("style");t.innerText=`.swal2-popup {font-size: ${e.containerFontSize}}`,document.head.appendChild(t)}}}probe(...e){F()||this.forms.addLine({etype:"custom error",msg:e})}report(){if(F())return;const e=C();S(e)||this.opts.report(e)}showPanel(){this.panel.toggleShow()}}}));
