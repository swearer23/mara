!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("nanoid"),require("file-saver"),require("sweetalert2"),require("hammerjs")):"function"==typeof define&&define.amd?define(["nanoid","file-saver","sweetalert2","hammerjs"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).Mara=t(e.nanoid,e.FileSaver,e.Swal,e.Hammer)}(this,(function(e,t,o,n){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var r=i(t),s=i(o),a=i(n);let p;const c={qq:/\bm?qqbrowser\/([0-9.]+)/,360:e=>-1!==e.indexOf("360 aphone browser")?/\b360 aphone browser \(([^\)]+)\)/:/\b360(?:se|ee|chrome|browser)\b/,aoyou:/\baoyou/,webview:/\bcpu(?: iphone)? os (?:[0-9._]+).+\bapplewebkit\b/,firefox:/\bfirefox\/([0-9.ab]+)/,chrome:/ (?:chrome|crios|crmo)\/([0-9.]+)/,ie:/\b(?:msie |ie |trident\/[0-9].*rv[ :])([0-9.]+)/,android:e=>-1===e.indexOf("android")?"":/\bversion\/([0-9.]+(?: beta)?)/,safari:/\bversion\/([0-9.]+(?: beta)?)(?: mobile(?:\/[a-z0-9]+)?)? safari\//,opera:/\bopera/,unknow:"unknow"},h={windows:/\bwindows nt ([0-9.]+)/,macosx:/\bmac os x ([0-9._]+)/,linux:"linux",wphone:e=>-1!==e.indexOf("windows phone ")?/\bwindows phone (?:os )?([0-9.]+)/:-1!==e.indexOf("xblwp")?/\bxblwp([0-9.]+)/:-1!==e.indexOf("zunewp")?/\bzunewp([0-9.]+)/:"windows phone",ios:e=>/\bcpu(?: iphone)? os /.test(e)?/\bcpu(?: iphone)? os ([0-9._]+)/:-1!==e.indexOf("iph os ")?/\biph os ([0-9_]+)/:/\bios\b/,android:e=>e.indexOf("android")>=0?/\bandroid[ \/-]?([0-9.x]+)?/:e.indexOf("adr")>=0?e.indexOf("mqqbrowser")>=0?/\badr[ ]\(linux; u; ([0-9.]+)?/:/\badr(?:[ ]([0-9.]+))?/:"android",unknow:"unknow"},d={weixin:/micromessenger/gi,qqvideo:/qqlivebrowser/gi,qqvideoipad:/qqlivehdbrowser/gi,shouqq:/qq\//gi,qqnews:/qqnews/gi,qzone:/qzone\//gi,unknow:"unknow"},f=(e,t)=>Object.prototype.toString.call(e)===`[object ${t}]`,u=(e,t)=>{const o=w[e.toLowerCase()];for(const e in t){const n=t[e],i=f(n,"Function")?n(l()):n;if(o.name=e,!0===i)break;if("[object String]"===toString(i)){if(-1!==l().indexOf(i))break}else if(f(i,"Object")){if(void 0!==i.version){o.version=i.version;break}}else if(i&&i.exec){const e=i.exec(l());if(e){e.length>=2&&e[1]?o.version=e[1].replace(/_/g,"."):o.version="0.0.0";break}}}return o},l=()=>{if(!p){const e="__",t=navigator.userAgent||"",o=navigator.platform||"",n=navigator.appVersion||"",i=navigator.vendor||"";p=t+e+o+e+n+e+i,p=p.toLowerCase()}return p},m=e=>{p||(u("os",h),u("platform",d),u("browser",c));return"all"===e||"full"===e?l():void 0!==e?w[e].name:`${w.os.name}  _${w.os.version}  ${w.browser.name}  _${w.browser.version}`},w={os:{name:"unknow",version:"0.0.0"},platform:{name:"unknow",version:"0.0.0"},browser:{name:"unknow",version:"0.0.0"}},g=(...e)=>{const t=e[0],o=Array.prototype.slice.call(e,1);for(let e=0;e<o.length;e++){const n=o[e];for(const e in n)t[e]=n[e]}return t},b=e=>{if(!e)return!0;if(!e.length)return!0;let t=0;for(let o=e.length-1;o>0;o--)e[o]||(t+=1);return t>e.length-1},y=e=>{const t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";e=e||9;let o="";for(let n=0;n<e;n++)o+=t.charAt(Math.floor(Math.random()*t.length));return o};class x{constructor(){if(x.instance)return x.instance;this.__pool__={},x.instance=this}setItem(e,t){this.__pool__[e]=t}getItem(e){return this.__pool__[e]}remove(e){this.__pool__[e]=null}}x.instance=null;const v=new x,_="csijs_",q=e=>0===e.indexOf(_)?e:_+e,j=(e,t,o)=>{"object"==typeof t&&(t=o?t:(e=>{try{return JSON.stringify(e)}catch(t){return e}})(t)),((e,t)=>{try{v.setItem(e,t)}catch(e){console.error(e)}})(q(e),t)},L=(e,t)=>{const o=(e=>v.getItem?v.getItem(e):null)(q(e));return o?t?o:(e=>{try{return JSON.parse(e)}catch(t){return e}})(o):null},$=e=>{(e=>{try{v&&v.removeItem(e)}catch(e){}})(q(e))},k=()=>{const e=L("info"),t=[],o=e?e.length:0;if(e&&o){const o=parseInt(e.max,10);for(let n=parseInt(e.min,10);n<=o;n++){const o=`${e.type}_${n}`,i=L(o);t.push(i)}}return t};function O(e){this.appended=!1,this.csiReport=e}function S(e){this.csi=e}O.prototype.createPage=function(){s.fire({title:"正在收集日志"}).then((()=>{this.appended=!1})),setTimeout((()=>{if(this.appended){const t=k();b(t)?(s.update({title:"暂无异常",text:"稍后窗口会自动关闭",icon:"success"}),setTimeout((()=>{this.appended&&s.close()}),2e3)):s.update({title:"收集完成",text:`收集到${t.length}条日志，点击下方按钮下载日志`,icon:"success",showConfirmButton:!0,confirmButtonText:"下载",showCancelButton:!0,cancelButtonText:"关闭",preConfirm:()=>{const t=k().map((e=>`${JSON.stringify(e,null,2)}\n`));var o=new Blob(t,{type:"text/plain;charset=utf-8"});r.saveAs(o,`${e.nanoid()}.dat`)}})}}),500)},O.prototype.appendTo=function(){this.createPage(),this.appended=!0},O.prototype.remove=function(){this.appended=!1,s.close()},O.prototype.toggleShow=function(){this.appended||this.appendTo()},S.prototype={init(e=!1){this.showPage=new O(this.csi.report.bind(this.csi)),e||this.bindDefaultTrigger()}},S.prototype.bindDefaultTrigger=function(){var e=new a.Manager(document.querySelector("html")),t=new a.Tap({event:"quadrupletap",taps:4});e.add(t),e.on("quadrupletap",(()=>{this.showPage.toggleShow()})),document.addEventListener("keydown",(e=>{(e=e||window.event).ctrlKey&&6===parseInt(e.key,10)&&this.showPage.toggleShow()}))},S.prototype.toggleShow=function(){this.showPage.toggleShow()};const T=function(e){this.forms=e};T.prototype.probe=function(){const{onerror:e}=window;window.onerror=(...t)=>{var o,n,i,r,s,a;"function"==typeof e&&e.apply(this,t),o=this.forms,n=t[0],i=t[1],r=t[2],s=t[3],a=t[4],o.addLine({etype:"win error",msg:`${n} \n ${a&&a.stack}`,js:`${i}:${r}:${s}`})}};const I={},P=function(e){this.forms=e},M=(e,t,o)=>{e.addLine({etype:"ajax error",msg:t,js:o.join(" :")})};P.prototype.probe=function(t=!1){const o=this;this.logAjaxTrace=t;const{open:n,send:i,setRequestHeader:r}=XMLHttpRequest.prototype;XMLHttpRequest.prototype.open=function(){const t=e.nanoid();this.__xhrid=t,o.addListener(this,arguments),n.apply(this,arguments)},XMLHttpRequest.prototype.setRequestHeader=function(){const[e,t]=[...arguments];"content-type"===e.toLowerCase()&&"application/json"===t.toLowerCase()&&(I[this.__xhrid].recordPayload=!0),r.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){I[this.__xhrid].recordPayload&&(I[this.__xhrid].payload=[...arguments]),i.apply(this,arguments)}},P.prototype.addListener=function(e,t){if(I[e.__xhrid])return;I[e.__xhrid]={xhr:e};const{ontimeout:o}=e;e.addEventListener("loadend",(()=>{const o=e.status;let n,i=I[e.__xhrid].payload||{};try{i=JSON.parse(i)}catch(e){i=i}try{n=JSON.parse(e.response)}catch(t){n=e.response}const r={status:o,payload:i,response:n};0!==parseInt(o)&&(/^2[0-9]{1,3}/gi.test(o)?this.logAjaxTrace&&((e,t,o)=>{e.addLine({etype:"ajax trace",msg:t,js:o.join(":")})})(this.forms,r,[...t]):M(this.forms,r,[...t]))})),e.addEventListener("error",(()=>{M(this.forms,e.status||"networkError",[...t])})),e.ontimeout=(...n)=>{this.forms.addLine({etype:"ajax error",msg:`timeout ${e.status}`,js:t.join(" :")}),o&&o.apply(this,n)}};const R=function(e){this.forms=e};R.prototype.probe=function(){if(!window.fetch)return;const e=window.fetch;window.fetch=(t,o)=>{let n="GET",i=t||"";return"string"==typeof t?n=o&&o.method?o.method:n:"[object Request]"===Object.prototype.toString.call(t)&&(n=t.method||n,i=t.url||""),e(t,o).then((e=>{const t=`${e.status}`;return/^2[0-9]{1,3}/gi.test(t)||0==+t||this.forms.addLine({etype:"fetch error",msg:`status:${e.status}`,js:`${n} :${i}`}),e})).catch((e=>{let t;try{t=e&&e.message?e.message:JSON.stringify(e)}catch(o){t=e&&e.message?e.message:e}throw this.forms.addLine({etype:"fetch error",msg:t,js:`${n} :${i}`}),e}))}};const A=function(){this.fid="",this.uid="",this.min=0,this.max=0,this.type="",this.length=""},C=function(){this.pid="",this.index="",this.time="",this.ua="",this.etype="",this.msg="",this.url="",this.other=""},E=function(e,t,o){const n={feid:e,uid:y(),min:0,max:0,type:t,length:0};this.maxLine=o||20,this.info=g(new A,n,L("info")),this.line=new C};E.prototype={addLine(e){const t={pid:y(6),index:parseInt(this.info.max,10)+1,time:Date.now(),ua:m()};(e=>{for(const t in e)e[t]="";e.url=location?location.href:""})(this.line),g(this.line,t,e);const o=`${this.info.type}_${this.line.index}`;j(o,this.line),this.updateInfo(this.line)},updateInfo(e){const t=parseInt(e.index,10);let o=parseInt(this.info.min,10);o=o||t;let n=t-o+1;if(n>this.maxLine){const e=n-this.maxLine;for(let t=0;t<e;t++){const e=`${this.info.type}_${o+t}`;$(e)}n=this.maxLine}this.info.length=n,this.info.min=t-n+1,this.info.max=t,j("info",this.info)}};const H=function(e,t){this.errTable=new E(e,"err",t)};H.prototype={addLine(e){const t=this.errTable;setTimeout((()=>{t.addLine(e)}),0)}};const D=()=>{m();const{browser:e}=w,{name:t}=e,o=parseFloat(e.version);return"ie"===t&&o<9};return class{constructor(e={}){e.report=e.report||(()=>{console.warn("report needs to be defined")}),this.inited=!1,this.checkParams(e),this.init(e)}checkParams(e){if(!e.feID)throw Error("feID必传");if(!e.report||"function"!=typeof e.report)throw Error("请填写自定义上报函数")}init(e){if(!this.inited&&!D())try{this.opts=e;const t=new H(e.feID,e.maxLine);this.panel=new S(this),this.panel.init(e.customPanelTrigger),new T(t).probe(),new P(t).probe(e.logAjaxTrace),new R(t).probe(),this.inited=!0}catch(e){console.error(e)}}probe(e){D()||this.forms.addLine({etype:"custom error",msg:e})}report(){if(D())return;const e=k();b(e)||this.opts.report(e)}showPanel(){this.panel.toggleShow()}}}));
