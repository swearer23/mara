!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("nanoid"),require("file-saver"),require("sweetalert2"),require("axios"),require("ali-oss"),require("clipboard"),require("toastify-js")):"function"==typeof define&&define.amd?define(["nanoid","file-saver","sweetalert2","axios","ali-oss","clipboard","toastify-js"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).Mara=e(t.nanoid,t.FileSaver,t.Swal,t.axios,t.OSS,t.Clipboard,t.Toastify)}(this,(function(t,e,n,o,r,i,a){"use strict";function s(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var c,u=s(e),f=s(n),l=s(o),p=s(r),h=s(i),d=s(a);function y(t){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},y(t)}function m(t,e,n,o,r,i,a){try{var s=t[i](a),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(o,r)}function v(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function w(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function g(t,e,n){return e&&w(t.prototype,e),n&&w(t,n),t}function b(t){return function(t){if(Array.isArray(t))return x(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return x(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return x(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function x(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}var _={qq:/\bm?qqbrowser\/([0-9.]+)/,360:function(t){return-1!==t.indexOf("360 aphone browser")?/\b360 aphone browser \(([^\)]+)\)/:/\b360(?:se|ee|chrome|browser)\b/},aoyou:/\baoyou/,webview:/\bcpu(?: iphone)? os (?:[0-9._]+).+\bapplewebkit\b/,firefox:/\bfirefox\/([0-9.ab]+)/,chrome:/ (?:chrome|crios|crmo)\/([0-9.]+)/,ie:/\b(?:msie |ie |trident\/[0-9].*rv[ :])([0-9.]+)/,android:function(t){return-1===t.indexOf("android")?"":/\bversion\/([0-9.]+(?: beta)?)/},safari:/\bversion\/([0-9.]+(?: beta)?)(?: mobile(?:\/[a-z0-9]+)?)? safari\//,opera:/\bopera/,unknow:"unknow"},S={windows:/\bwindows nt ([0-9.]+)/,macosx:/\bmac os x ([0-9._]+)/,linux:"linux",wphone:function(t){return-1!==t.indexOf("windows phone ")?/\bwindows phone (?:os )?([0-9.]+)/:-1!==t.indexOf("xblwp")?/\bxblwp([0-9.]+)/:-1!==t.indexOf("zunewp")?/\bzunewp([0-9.]+)/:"windows phone"},ios:function(t){return/\bcpu(?: iphone)? os /.test(t)?/\bcpu(?: iphone)? os ([0-9._]+)/:-1!==t.indexOf("iph os ")?/\biph os ([0-9_]+)/:/\bios\b/},android:function(t){return t.indexOf("android")>=0?/\bandroid[ \/-]?([0-9.x]+)?/:t.indexOf("adr")>=0?t.indexOf("mqqbrowser")>=0?/\badr[ ]\(linux; u; ([0-9.]+)?/:/\badr(?:[ ]([0-9.]+))?/:"android"},unknow:"unknow"},q={weixin:/micromessenger/gi,qqvideo:/qqlivebrowser/gi,qqvideoipad:/qqlivehdbrowser/gi,shouqq:/qq\//gi,qqnews:/qqnews/gi,qzone:/qzone\//gi,unknow:"unknow"},k=function(t,e){return Object.prototype.toString.call(t)==="[object ".concat(e,"]")},j=function(t,e){var n=T[t.toLowerCase()];for(var o in e){var r=e[o],i=k(r,"Function")?r(A()):r;if(n.name=o,!0===i)break;if("[object String]"===toString(i)){if(-1!==A().indexOf(i))break}else if(k(i,"Object")){if(void 0!==i.version){n.version=i.version;break}}else if(i&&i.exec){var a=i.exec(A());if(a){a.length>=2&&a[1]?n.version=a[1].replace(/_/g,"."):n.version="0.0.0";break}}}return n},A=function(){if(!c){var t="__",e=navigator.userAgent||"",n=navigator.platform||"",o=navigator.appVersion||"",r=navigator.vendor||"";c=(c=e+t+n+t+o+t+r).toLowerCase()}return c},L=function(t){c||(j("os",S),j("platform",q),j("browser",_));return"all"===t||"full"===t?A():void 0!==t?T[t].name:"".concat(T.os.name).concat("  ","_").concat(T.os.version,"  ").concat(T.browser.name).concat("  ","_").concat(T.browser.version)},T={os:{name:"unknow",version:"0.0.0"},platform:{name:"unknow",version:"0.0.0"},browser:{name:"unknow",version:"0.0.0"}},O=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var o=e[0],r=Array.prototype.slice.call(e,1),i=0;i<r.length;i++){var a=r[i];for(var s in a)o[s]=a[s]}return o},I=function(t){if(!t)return!0;if(!t.length)return!0;for(var e=0,n=t.length-1;n>0;n--)t[n]||(e+=1);return e>t.length-1},C=function(t){var e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";t=t||9;for(var n="",o=0;o<t;o++)n+=e.charAt(Math.floor(Math.random()*e.length));return n},P=function(){function t(){if(v(this,t),t.instance)return t.instance;this.__pool__={},t.instance=this}return g(t,[{key:"setItem",value:function(t,e){this.__pool__[t]=e}},{key:"getItem",value:function(t){return this.__pool__[t]}},{key:"remove",value:function(t){this.__pool__[t]=null}}]),t}();P.instance=null;var B=new P,R="csijs_",z=function(t){return 0===t.indexOf(R)?t:R+t},E=function(t,e,n){"object"===y(e)&&(e=n?e:function(t){try{return JSON.stringify(t)}catch(e){return t}}(e)),function(t,e){try{B.setItem(t,e)}catch(t){console.error(t)}}(z(t),e)},K=function(t,e){var n=function(t){return B.getItem?B.getItem(t):null}(z(t));return n?e?n:function(t){try{return JSON.parse(t)}catch(e){return t}}(n):null},M=function(t){!function(t){try{B&&B.removeItem(t)}catch(t){}}(z(t))},Q=function(){var t=K("info"),e=[],n=t?t.length:0;if(t&&n)for(var o=parseInt(t.max,10),r=parseInt(t.min,10);r<=o;r++){var i="".concat(t.type,"_").concat(r),a=K(i);e.push(a)}return e},J={download:"下载",copy:"复制",upload:"上传",report:"上报"},N=null;function D(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"download",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"prod";this.csiReport=t,this.env=n,J[e]&&("copy"===e&&console.error("mara warning:operationMethod===copy功能即将废弃，请尽快切换成'upload'或者'download'模式"),this.operation=e,this.mainBtnText=J[e])}var H=function(){var e,n=(e=regeneratorRuntime.mark((function e(n){var o,r,i,a,s,c,u,y;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=Q().map((function(t){return"".concat(JSON.stringify(t,null,2),"\n")})),r=new Blob(o,{type:"text/plain;charset=utf-8"}),i="".concat(t.nanoid(),".dat"),"prod"===n?(a="https://m7-hlgw-c1-openapi.longfor.com/julianos-prod/api/admin/alioss/sts",s="a2e33eb4-6516-43f9-bcc0-9c47b0f123b3"):(a="//api-uat.longfor.com/julianos-uat/api/admin/alioss/sts",s="791f6690-0714-445f-9273-78a3199622d2"),e.next=6,l({method:"get",url:a,withCredentials:!0,headers:{"X-Gaia-Api-Key":s}});case 6:return c=e.sent.data.Credentials,u=new p({region:"oss-cn-beijing",accessKeyId:c.AccessKeyId,accessKeySecret:c.AccessKeySecret,stsToken:c.SecurityToken,bucket:"prod-zws-wuguofeng"}),e.next=10,u.put("mara/".concat(i),r);case 10:return e.next=12,u.signatureUrl("mara/".concat(i));case 12:y=e.sent,f.fire({title:"上传完成",icon:"success",showConfirmButton:!0,confirmButtonText:"复制链接",showCancelButton:!0,cancelButtonText:"关闭",preConfirm:function(){document.querySelector(".swal2-confirm").setAttribute("data-clipboard-text",y),N&&N.destroy(),(N=new h(".swal2-confirm")).on("success",(function(t){console.log(t),d({text:"链接已复制",duration:1e3,gravity:"bottom",position:"center",style:{position:"fixed",margin:"0 auto",left:0,right:0,width:"80px",textAlign:"center",background:"black",zIndex:"999999",padding:"5px",opacity:.8,borderRadius:"5px",color:"white"}}).showToast(),t.clearSelection()}))}});case 14:case"end":return e.stop()}}),e)})),function(){var t=this,n=arguments;return new Promise((function(o,r){var i=e.apply(t,n);function a(t){m(i,o,r,a,s,"next",t)}function s(t){m(i,o,r,a,s,"throw",t)}a(void 0)}))});return function(t){return n.apply(this,arguments)}}();function F(t){this.csi=t,this.tapQueue=[]}D.prototype.createPage=function(){var e=this,n=Q();I(n)?f.fire({title:"暂无异常",text:"稍后窗口会自动关闭",icon:"success",heightAuto:!1,timer:2e3}):f.fire({title:"收集完成",text:"收集到".concat(n.length,"条日志，点击下方按钮下载日志"),icon:"success",heightAuto:!1,showConfirmButton:!0,confirmButtonText:this.mainBtnText,showCancelButton:!0,cancelButtonText:"关闭",preConfirm:function(){return"upload"===e.operation?H(e.env):"copy"===e.operation?function(){var t=JSON.stringify(Q(),null,2);document.querySelector(".swal2-confirm").setAttribute("data-clipboard-text",t),N&&N.destroy(),(N=new h(".swal2-confirm")).on("success",(function(t){d({text:"复制成功",duration:1e3,gravity:"bottom",position:"center",style:{position:"fixed",margin:"0 auto",left:0,right:0,width:"80px",textAlign:"center",background:"black",zIndex:"999999",padding:"5px",opacity:.8,borderRadius:"5px",color:"white"}}).showToast(),t.clearSelection()}))}():function(){var e=Q().map((function(t){return"".concat(JSON.stringify(t,null,2),"\n")})),n=new Blob(e,{type:"text/plain;charset=utf-8"}),o="".concat(t.nanoid(),".dat");u.saveAs(n,o)}()}})},D.prototype.toggleShow=function(){f.isVisible()||this.createPage()},F.prototype={init:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;this.showPage=new D(this.csi.report.bind(this.csi),e,n),t||this.bindDefaultTrigger()},onTapQueue:function(t,e){var n=this.tapQueue.length?this.tapQueue[this.tapQueue.length-1]:null;if(n&&t.timeStamp-n.timeStamp>300&&(this.tapQueue=[]),this.tapQueue.push(t),this.tapQueue.length===e)return this.tapQueue=[],!0}},F.prototype.bindDefaultTrigger=function(){var t=this;document.querySelector("html").addEventListener("touchend",(function(e){t.onTapQueue(e,4)&&setTimeout(t.toggleShow.bind(t),100)})),document.addEventListener("keydown",(function(e){(e=e||window.event).ctrlKey&&6===parseInt(e.key,10)&&t.showPage.toggleShow()}))},F.prototype.toggleShow=function(){this.showPage.toggleShow()};var X=function(t,e,n,o,r,i){return t.addLine({etype:"win error",msg:"".concat(e," \n ").concat(i&&i.stack),js:"".concat(n,":").concat(o,":").concat(r)}),!0},G=function(t){this.forms=t};G.prototype.probe=function(){var t=this,e=window.onerror;window.onerror=function(){for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];"function"==typeof e&&e.apply(t,o),X(t.forms,o[0],o[1],o[2],o[3],o[4])}};var U={},V=function(t){this.forms=t},W=function(t,e,n){t.addLine({etype:"ajax error",msg:e,js:n.join(" :")})};V.prototype.probe=function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],o=arguments.length>1?arguments[1]:void 0,r=this;this.logAjaxTrace=n,this.excludeKeywords=o||[];var i=XMLHttpRequest.prototype,a=i.open,s=i.send,c=i.setRequestHeader,u=function(t){for(var n=0;n<e.excludeKeywords.length;n++)if(-1!==t.indexOf(e.excludeKeywords[n]))return!0;return!1};XMLHttpRequest.prototype.open=function(){var e=Array.prototype.slice.call(arguments);if(e[1]&&u(e[1]))return a.apply(this,arguments);var n=t.nanoid();this.__xhrid=n,r.addListener(this,arguments),a.apply(this,arguments)},XMLHttpRequest.prototype.setRequestHeader=function(){if(!this.__xhrid)return c.apply(this,arguments);var t=Array.prototype.slice.call(arguments),e=t[0],n=t[1];"content-type"===e.toLowerCase()&&n.toLowerCase().includes("application/json")&&(U[this.__xhrid].recordPayload=!0),c.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){if(!this.__xhrid)return s.apply(this,arguments);U[this.__xhrid].recordPayload&&(U[this.__xhrid].payload=Array.prototype.slice.call(arguments)),s.apply(this,arguments)}},V.prototype.addListener=function(t,e){var n=this;if(!U[t.__xhrid]){U[t.__xhrid]={xhr:t};var o=t.ontimeout;t.addEventListener("loadend",(function(){var o,r=t.status,i=U[t.__xhrid].payload||{};try{i=JSON.parse(i)}catch(t){i=i}try{o=JSON.parse(t.response)}catch(e){o=t.response}var a={status:r,payload:i,response:o};0!==parseInt(r)&&(/^2[0-9]{1,3}/gi.test(r)?n.logAjaxTrace&&function(t,e,n){t.addLine({etype:"ajax trace",msg:e,js:n.join(":")})}(n.forms,a,b(e)):W(n.forms,a,b(e)))})),t.addEventListener("error",(function(){W(n.forms,t.status||"networkError",b(e))})),t.ontimeout=function(){n.forms.addLine({etype:"ajax error",msg:"timeout ".concat(t.status),js:e.join(" :")});for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];o&&o.apply(n,i)}}};var Y=function(t){this.forms=t};Y.prototype.probe=function(){var t=this;if(window.fetch){var e=window.fetch;window.fetch=function(n,o){var r="GET",i=n||"";return"string"==typeof n?r=o&&o.method?o.method:r:"[object Request]"===Object.prototype.toString.call(n)&&(r=n.method||r,i=n.url||""),e(n,o).then((function(e){var n="".concat(e.status);return/^2[0-9]{1,3}/gi.test(n)||0==+n||t.forms.addLine({etype:"fetch error",msg:"status:".concat(e.status),js:"".concat(r," :").concat(i)}),e})).catch((function(e){var n;try{n=e&&e.message?e.message:JSON.stringify(e)}catch(t){n=e&&e.message?e.message:e}throw t.forms.addLine({etype:"fetch error",msg:n,js:"".concat(r," :").concat(i)}),e}))}}};var Z=function(){this.fid="",this.uid="",this.min=0,this.max=0,this.type="",this.length=""},$=function(){this.pid="",this.index="",this.time="",this.ua="",this.etype="",this.msg="",this.url="",this.other=""},tt=function(t,e,n){var o={feid:t,uid:C(),min:0,max:0,type:e,length:0};this.maxLine=n||20,this.info=O(new Z,o,K("info")),this.line=new $};tt.prototype={addLine:function(t){var e={pid:C(6),index:parseInt(this.info.max,10)+1,time:Date.now(),ua:L()};!function(t){for(var e in t)t[e]="";t.url=location?location.href:""}(this.line),O(this.line,e,t);var n="".concat(this.info.type,"_").concat(this.line.index);E(n,this.line),this.updateInfo(this.line)},updateInfo:function(t){var e=parseInt(t.index,10),n=parseInt(this.info.min,10),o=e-(n=n||e)+1;if(o>this.maxLine){for(var r=o-this.maxLine,i=0;i<r;i++){var a="".concat(this.info.type,"_").concat(n+i);M(a)}o=this.maxLine}this.info.length=o,this.info.min=e-o+1,this.info.max=e,E("info",this.info)}};var et=function(t,e){this.errTable=new tt(t,"err",e)};et.prototype={addLine:function(t){var e=this.errTable;setTimeout((function(){e.addLine(t)}),0)}};var nt=function(){L();var t=T.browser,e=t.name,n=parseFloat(t.version);return"ie"===e&&n<9},ot=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};v(this,t),e.report=e.report||function(){console.warn("report needs to be defined")},this.inited=!1,this.checkParams(e),this.init(e)}return g(t,[{key:"checkParams",value:function(t){if(!t.feID)throw Error("feID必传");if(!t.report||"function"!=typeof t.report)throw Error("请填写自定义上报函数")}},{key:"init",value:function(t){if(!this.inited&&!nt()){try{this.opts=t;var e=new et(t.feID,t.maxLine);this.forms=e,this.panel=new F(this),this.panel.init(t.customPanelTrigger,t.operationMethod,t.env),new G(e).probe(),new V(e).probe(t.logAjaxTrace,t.excludeAjaxKeywords),new Y(e).probe(),this.inited=!0}catch(t){console.error(t)}if(t.containerFontSize){var n=document.createElement("style");n.innerText=".swal2-popup {font-size: ".concat(t.containerFontSize,"}"),document.head.appendChild(n)}}}},{key:"probe",value:function(){if(!nt()){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];this.forms.addLine({etype:"custom error",msg:e})}}},{key:"report",value:function(){if(!nt()){var t=Q();I(t)||this.opts.report(t)}}},{key:"showPanel",value:function(){this.panel.toggleShow()}}]),t}();return ot}));
