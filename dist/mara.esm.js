import{nanoid as t}from"nanoid";import e from"file-saver";import n from"sweetalert2";import o from"axios";import r from"ali-oss";import i from"clipboard";import a from"toastify-js";function s(t){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},s(t)}function c(t,e,n,o,r,i,a){try{var s=t[i](a),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(o,r)}function u(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function f(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function p(t,e,n){return e&&f(t.prototype,e),n&&f(t,n),t}function l(t){return function(t){if(Array.isArray(t))return h(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return h(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return h(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}var d,m={qq:/\bm?qqbrowser\/([0-9.]+)/,360:function(t){return-1!==t.indexOf("360 aphone browser")?/\b360 aphone browser \(([^\)]+)\)/:/\b360(?:se|ee|chrome|browser)\b/},aoyou:/\baoyou/,webview:/\bcpu(?: iphone)? os (?:[0-9._]+).+\bapplewebkit\b/,firefox:/\bfirefox\/([0-9.ab]+)/,chrome:/ (?:chrome|crios|crmo)\/([0-9.]+)/,ie:/\b(?:msie |ie |trident\/[0-9].*rv[ :])([0-9.]+)/,android:function(t){return-1===t.indexOf("android")?"":/\bversion\/([0-9.]+(?: beta)?)/},safari:/\bversion\/([0-9.]+(?: beta)?)(?: mobile(?:\/[a-z0-9]+)?)? safari\//,opera:/\bopera/,unknow:"unknow"},y={windows:/\bwindows nt ([0-9.]+)/,macosx:/\bmac os x ([0-9._]+)/,linux:"linux",wphone:function(t){return-1!==t.indexOf("windows phone ")?/\bwindows phone (?:os )?([0-9.]+)/:-1!==t.indexOf("xblwp")?/\bxblwp([0-9.]+)/:-1!==t.indexOf("zunewp")?/\bzunewp([0-9.]+)/:"windows phone"},ios:function(t){return/\bcpu(?: iphone)? os /.test(t)?/\bcpu(?: iphone)? os ([0-9._]+)/:-1!==t.indexOf("iph os ")?/\biph os ([0-9_]+)/:/\bios\b/},android:function(t){return t.indexOf("android")>=0?/\bandroid[ \/-]?([0-9.x]+)?/:t.indexOf("adr")>=0?t.indexOf("mqqbrowser")>=0?/\badr[ ]\(linux; u; ([0-9.]+)?/:/\badr(?:[ ]([0-9.]+))?/:"android"},unknow:"unknow"},v={weixin:/micromessenger/gi,qqvideo:/qqlivebrowser/gi,qqvideoipad:/qqlivehdbrowser/gi,shouqq:/qq\//gi,qqnews:/qqnews/gi,qzone:/qzone\//gi,unknow:"unknow"},w=function(t,e){return Object.prototype.toString.call(t)==="[object ".concat(e,"]")},g=function(t,e){var n=_[t.toLowerCase()];for(var o in e){var r=e[o],i=w(r,"Function")?r(b()):r;if(n.name=o,!0===i)break;if("[object String]"===toString(i)){if(-1!==b().indexOf(i))break}else if(w(i,"Object")){if(void 0!==i.version){n.version=i.version;break}}else if(i&&i.exec){var a=i.exec(b());if(a){a.length>=2&&a[1]?n.version=a[1].replace(/_/g,"."):n.version="0.0.0";break}}}return n},b=function(){if(!d){var t="__",e=navigator.userAgent||"",n=navigator.platform||"",o=navigator.appVersion||"",r=navigator.vendor||"";d=(d=e+t+n+t+o+t+r).toLowerCase()}return d},x=function(t){d||(g("os",y),g("platform",v),g("browser",m));return"all"===t||"full"===t?b():void 0!==t?_[t].name:"".concat(_.os.name).concat("  ","_").concat(_.os.version,"  ").concat(_.browser.name).concat("  ","_").concat(_.browser.version)},_={os:{name:"unknow",version:"0.0.0"},platform:{name:"unknow",version:"0.0.0"},browser:{name:"unknow",version:"0.0.0"}},S=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var o=e[0],r=Array.prototype.slice.call(e,1),i=0;i<r.length;i++){var a=r[i];for(var s in a)o[s]=a[s]}return o},k=function(t){if(!t)return!0;if(!t.length)return!0;for(var e=0,n=t.length-1;n>0;n--)t[n]||(e+=1);return e>t.length-1},j=function(t){var e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";t=t||9;for(var n="",o=0;o<t;o++)n+=e.charAt(Math.floor(Math.random()*e.length));return n},q=function(){function t(){if(u(this,t),t.instance)return t.instance;this.__pool__={},t.instance=this}return p(t,[{key:"setItem",value:function(t,e){this.__pool__[t]=e}},{key:"getItem",value:function(t){return this.__pool__[t]}},{key:"remove",value:function(t){this.__pool__[t]=null}}]),t}();q.instance=null;var A=new q,L=function(t){return 0===t.indexOf("csijs_")?t:"csijs_"+t},O=function(t,e,n){"object"===s(e)&&(e=n?e:function(t){try{return JSON.stringify(t)}catch(e){return t}}(e)),function(t,e){try{A.setItem(t,e)}catch(t){console.error(t)}}(L(t),e)},T=function(t,e){var n=function(t){return A.getItem?A.getItem(t):null}(L(t));return n?e?n:function(t){try{return JSON.parse(t)}catch(e){return t}}(n):null},I=function(t){!function(t){try{A&&A.removeItem(t)}catch(t){}}(L(t))},C=function(){var t=T("info"),e=[],n=t?t.length:0;if(t&&n)for(var o=parseInt(t.max,10),r=parseInt(t.min,10);r<=o;r++){var i="".concat(t.type,"_").concat(r),a=T(i);e.push(a)}return e},P={download:"下载",copy:"复制",upload:"上传",report:"上报"},B=null;function R(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"download",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"prod";this.csiReport=t,this.env=n,P[e]&&("copy"===e&&console.error("mara warning:operationMethod===copy功能即将废弃，请尽快切换成'upload'或者'download'模式"),this.operation=e,this.mainBtnText=P[e])}var z=function(){var e,s=(e=regeneratorRuntime.mark((function e(s){var c,u,f,p,l,h,d,m;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=C().map((function(t){return"".concat(JSON.stringify(t,null,2),"\n")})),u=new Blob(c,{type:"text/plain;charset=utf-8"}),f="".concat(t(),".dat"),"prod"===s?(p="https://m7-hlgw-c1-openapi.longfor.com/julianos-prod/api/admin/alioss/sts",l="a2e33eb4-6516-43f9-bcc0-9c47b0f123b3"):(p="//api-uat.longfor.com/julianos-uat/api/admin/alioss/sts",l="791f6690-0714-445f-9273-78a3199622d2"),e.next=6,o({method:"get",url:p,withCredentials:!0,headers:{"X-Gaia-Api-Key":l}});case 6:return h=e.sent.data.Credentials,d=new r({region:"oss-cn-beijing",accessKeyId:h.AccessKeyId,accessKeySecret:h.AccessKeySecret,stsToken:h.SecurityToken,bucket:"prod-zws-wuguofeng"}),e.next=10,d.put("mara/".concat(f),u);case 10:return e.next=12,d.signatureUrl("mara/".concat(f));case 12:m=e.sent,n.fire({title:"上传完成",icon:"success",showConfirmButton:!0,confirmButtonText:"复制链接",showCancelButton:!0,cancelButtonText:"关闭",preConfirm:function(){document.querySelector(".swal2-confirm").setAttribute("data-clipboard-text",m),B&&B.destroy(),(B=new i(".swal2-confirm")).on("success",(function(t){console.log(t),a({text:"链接已复制",duration:1e3,gravity:"bottom",position:"center",style:{position:"fixed",margin:"0 auto",left:0,right:0,width:"80px",textAlign:"center",background:"black",zIndex:"999999",padding:"5px",opacity:.8,borderRadius:"5px",color:"white"}}).showToast(),t.clearSelection()}))}});case 14:case"end":return e.stop()}}),e)})),function(){var t=this,n=arguments;return new Promise((function(o,r){var i=e.apply(t,n);function a(t){c(i,o,r,a,s,"next",t)}function s(t){c(i,o,r,a,s,"throw",t)}a(void 0)}))});return function(t){return s.apply(this,arguments)}}();function E(t){this.csi=t,this.tapQueue=[]}R.prototype.createPage=function(){var o=this,r=C();k(r)?n.fire({title:"暂无异常",text:"稍后窗口会自动关闭",icon:"success",heightAuto:!1,timer:2e3}):n.fire({title:"收集完成",text:"收集到".concat(r.length,"条日志，点击下方按钮下载日志"),icon:"success",heightAuto:!1,showConfirmButton:!0,confirmButtonText:this.mainBtnText,showCancelButton:!0,cancelButtonText:"关闭",preConfirm:function(){return"upload"===o.operation?z(o.env):"copy"===o.operation?function(){var t=JSON.stringify(C(),null,2);document.querySelector(".swal2-confirm").setAttribute("data-clipboard-text",t),B&&B.destroy(),(B=new i(".swal2-confirm")).on("success",(function(t){a({text:"复制成功",duration:1e3,gravity:"bottom",position:"center",style:{position:"fixed",margin:"0 auto",left:0,right:0,width:"80px",textAlign:"center",background:"black",zIndex:"999999",padding:"5px",opacity:.8,borderRadius:"5px",color:"white"}}).showToast(),t.clearSelection()}))}():function(){var n=C().map((function(t){return"".concat(JSON.stringify(t,null,2),"\n")})),o=new Blob(n,{type:"text/plain;charset=utf-8"}),r="".concat(t(),".dat");e.saveAs(o,r)}()}})},R.prototype.toggleShow=function(){n.isVisible()||this.createPage()},E.prototype={init:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;this.showPage=new R(this.csi.report.bind(this.csi),e,n),t||this.bindDefaultTrigger()},onTapQueue:function(t,e){var n=this.tapQueue.length?this.tapQueue[this.tapQueue.length-1]:null;if(n&&t.timeStamp-n.timeStamp>300&&(this.tapQueue=[]),this.tapQueue.push(t),this.tapQueue.length===e)return this.tapQueue=[],!0}},E.prototype.bindDefaultTrigger=function(){var t=this;document.querySelector("html").addEventListener("touchend",(function(e){t.onTapQueue(e,4)&&setTimeout(t.toggleShow.bind(t),100)})),document.addEventListener("keydown",(function(e){(e=e||window.event).ctrlKey&&6===parseInt(e.key,10)&&t.showPage.toggleShow()}))},E.prototype.toggleShow=function(){this.showPage.toggleShow()};var K=function(t,e,n,o,r,i){return t.addLine({etype:"win error",msg:"".concat(e," \n ").concat(i&&i.stack),js:"".concat(n,":").concat(o,":").concat(r)}),!0},Q=function(t){this.forms=t};Q.prototype.probe=function(){var t=this,e=window.onerror;window.onerror=function(){for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];"function"==typeof e&&e.apply(t,o),K(t.forms,o[0],o[1],o[2],o[3],o[4])}};var M={},J=function(t){this.forms=t},N=function(t,e,n){t.addLine({etype:"ajax error",msg:e,js:n.join(" :")})};J.prototype.probe=function(){var e=this,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],o=arguments.length>1?arguments[1]:void 0,r=this;this.logAjaxTrace=n,this.excludeKeywords=o||[];var i=XMLHttpRequest.prototype,a=i.open,s=i.send,c=i.setRequestHeader,u=function(t){for(var n=0;n<e.excludeKeywords.length;n++)if(-1!==t.indexOf(e.excludeKeywords[n]))return!0;return!1};XMLHttpRequest.prototype.open=function(){var e=Array.prototype.slice.call(arguments);if(e[1]&&u(e[1]))return a.apply(this,arguments);var n=t();this.__xhrid=n,r.addListener(this,arguments),a.apply(this,arguments)},XMLHttpRequest.prototype.setRequestHeader=function(){if(!this.__xhrid)return c.apply(this,arguments);var t=Array.prototype.slice.call(arguments),e=t[0],n=t[1];"content-type"===e.toLowerCase()&&n.toLowerCase().includes("application/json")&&(M[this.__xhrid].recordPayload=!0),c.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){if(!this.__xhrid)return s.apply(this,arguments);M[this.__xhrid].recordPayload&&(M[this.__xhrid].payload=Array.prototype.slice.call(arguments)),s.apply(this,arguments)}},J.prototype.addListener=function(t,e){var n=this;if(!M[t.__xhrid]){M[t.__xhrid]={xhr:t};var o=t.ontimeout;t.addEventListener("loadend",(function(){var o,r=t.status,i=M[t.__xhrid].payload||{};try{i=JSON.parse(i)}catch(t){i=i}try{o=JSON.parse(t.response)}catch(e){o=t.response}var a={status:r,payload:i,response:o};0!==parseInt(r)&&(/^2[0-9]{1,3}/gi.test(r)?n.logAjaxTrace&&function(t,e,n){t.addLine({etype:"ajax trace",msg:e,js:n.join(":")})}(n.forms,a,l(e)):N(n.forms,a,l(e)))})),t.addEventListener("error",(function(){N(n.forms,t.status||"networkError",l(e))})),t.ontimeout=function(){n.forms.addLine({etype:"ajax error",msg:"timeout ".concat(t.status),js:e.join(" :")});for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];o&&o.apply(n,i)}}};var D=function(t){this.forms=t};D.prototype.probe=function(){var t=this;if(window.fetch){var e=window.fetch;window.fetch=function(n,o){var r="GET",i=n||"";return"string"==typeof n?r=o&&o.method?o.method:r:"[object Request]"===Object.prototype.toString.call(n)&&(r=n.method||r,i=n.url||""),e(n,o).then((function(e){var n="".concat(e.status);return/^2[0-9]{1,3}/gi.test(n)||0==+n||t.forms.addLine({etype:"fetch error",msg:"status:".concat(e.status),js:"".concat(r," :").concat(i)}),e})).catch((function(e){var n;try{n=e&&e.message?e.message:JSON.stringify(e)}catch(t){n=e&&e.message?e.message:e}throw t.forms.addLine({etype:"fetch error",msg:n,js:"".concat(r," :").concat(i)}),e}))}}};var H=function(){this.fid="",this.uid="",this.min=0,this.max=0,this.type="",this.length=""},X=function(){this.pid="",this.index="",this.time="",this.ua="",this.etype="",this.msg="",this.url="",this.other=""},F=function(t,e,n){var o={feid:t,uid:j(),min:0,max:0,type:e,length:0};this.maxLine=n||20,this.info=S(new H,o,T("info")),this.line=new X};F.prototype={addLine:function(t){var e={pid:j(6),index:parseInt(this.info.max,10)+1,time:Date.now(),ua:x()};!function(t){for(var e in t)t[e]="";t.url=location?location.href:""}(this.line),S(this.line,e,t);var n="".concat(this.info.type,"_").concat(this.line.index);O(n,this.line),this.updateInfo(this.line)},updateInfo:function(t){var e=parseInt(t.index,10),n=parseInt(this.info.min,10),o=e-(n=n||e)+1;if(o>this.maxLine){for(var r=o-this.maxLine,i=0;i<r;i++){var a="".concat(this.info.type,"_").concat(n+i);I(a)}o=this.maxLine}this.info.length=o,this.info.min=e-o+1,this.info.max=e,O("info",this.info)}};var G=function(t,e){this.errTable=new F(t,"err",e)};G.prototype={addLine:function(t){var e=this.errTable;setTimeout((function(){e.addLine(t)}),0)}};var U=function(){x();var t=_.browser,e=t.name,n=parseFloat(t.version);return"ie"===e&&n<9},V=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};u(this,t),e.report=e.report||function(){console.warn("report needs to be defined")},this.inited=!1,this.checkParams(e),this.init(e)}return p(t,[{key:"checkParams",value:function(t){if(!t.feID)throw Error("feID必传");if(!t.report||"function"!=typeof t.report)throw Error("请填写自定义上报函数")}},{key:"init",value:function(t){if(!this.inited&&!U()){try{this.opts=t;var e=new G(t.feID,t.maxLine);this.forms=e,this.panel=new E(this),this.panel.init(t.customPanelTrigger,t.operationMethod,t.env),new Q(e).probe(),new J(e).probe(t.logAjaxTrace,t.excludeAjaxKeywords),new D(e).probe(),this.inited=!0}catch(t){console.error(t)}if(t.containerFontSize){var n=document.createElement("style");n.innerText=".swal2-popup {font-size: ".concat(t.containerFontSize,"}"),document.head.appendChild(n)}}}},{key:"probe",value:function(){if(!U()){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];this.forms.addLine({etype:"custom error",msg:e})}}},{key:"report",value:function(){if(!U()){var t=C();k(t)||this.opts.report(t)}}},{key:"showPanel",value:function(){this.panel.toggleShow()}}]),t}();export{V as default};
