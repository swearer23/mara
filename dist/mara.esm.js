import t from"crypto-js";import{nanoid as e}from"nanoid";import o from"file-saver";import i from"sweetalert2";import s from"axios";import n from"ali-oss";import r from"clipboard";import a from"toastify-js";class c{constructor(t,e){if(c.instance)return c.instance;this.__pool__=[],this.feid=t,this.maxLine=parseInt(e)||20,c.instance=this}addLine(t){this.__pool__.length>=this.maxLine&&this.__pool__.shift(),this.__pool__.push(Object.assign({feid:this.feid},t))}readLines(){return this.__pool__}}c.instance=null;const p=()=>c.instance.readLines();let h=null;const d={download:"下载",upload:"上传"};function l(t,e){this.operation=e.operationMethod||"download",this.mainBtnText=d[this.operation],this.csiReport=t,this.env=e.env||"prod",this.appid=e.appid,this.appname=e.feID}const u=async(o,c,d)=>{const l=p().map((t=>`${JSON.stringify(t,null,2)}\n`)),u=new Blob(l,{type:"text/plain;charset=utf-8"}),f=`${e()}.dat`,m=(new Date).getTime(),g=(t=>{const e=t=>t>=65&&t<91||t>=97&&t<123,o=t.toString().split("");let i="",s=0;for(;s<13;){const t=o[s],n=`${t}${o[s+1]}`,r=`${n}${o[s+2]}`;0!==parseInt(t)?e(parseInt(n))?(i+=String.fromCharCode(n),s+=2):e(parseInt(r))?(i+=String.fromCharCode(r),s+=3):(i+=t,s++):(i=`${i}${t}`,s++)}return i.split("").reverse().join("")})(m),y=((e,o)=>t.MD5(`${e}${o}`))(c,m);let w,x,_,b;"prod"===o?(w="https://m7-hlgw-c1-openapi.longfor.com/julianos-prod/",b="a2e33eb4-6516-43f9-bcc0-9c47b0f123b3"):(w="//api-uat.longfor.com/julianos-uat/",b="791f6690-0714-445f-9273-78a3199622d2");const $={"X-Gaia-Api-Key":b};c?(x="api/mara/alioss/sts",$["x-mara-signature"]=y,$["x-mara-slug"]=g,$["x-mara-app-name"]=d):x="api/admin/alioss/sts",_=`${w}${x}`;const{Credentials:S}=(await s({method:"get",url:_,withCredentials:!0,headers:$})).data,L=new n({region:"oss-cn-beijing",accessKeyId:S.AccessKeyId,accessKeySecret:S.AccessKeySecret,stsToken:S.SecurityToken,bucket:"prod-zws-wuguofeng"});await L.put(`mara/${f}`,u);const j=await L.signatureUrl(`mara/${f}`);i.fire({title:"上传完成",icon:"success",showConfirmButton:!0,confirmButtonText:"复制链接",showCancelButton:!0,cancelButtonText:"关闭",preConfirm:()=>{document.querySelector(".swal2-confirm").setAttribute("data-clipboard-text",j),h&&h.destroy(),h=new r(".swal2-confirm"),h.on("success",(function(t){console.log(t),a({text:"链接已复制",duration:1e3,gravity:"bottom",position:"center",style:{position:"fixed",margin:"0 auto",left:0,right:0,width:"80px",textAlign:"center",background:"black",zIndex:"999999",padding:"5px",opacity:.8,borderRadius:"5px",color:"white"}}).showToast(),t.clearSelection()}))}})};function f(t){this.csi=t,this.tapQueue=[]}l.prototype.createPage=function(){const t=p();t.length?i.fire({title:"收集完成",text:`收集到${t.length}条日志，点击下方按钮下载日志`,icon:"success",heightAuto:!1,showConfirmButton:!0,confirmButtonText:this.mainBtnText,showCancelButton:!0,cancelButtonText:"关闭",preConfirm:()=>"upload"===this.operation?u(this.env,this.appid,this.appname):"copy"===this.operation?(()=>{const t=JSON.stringify(p(),null,2);document.querySelector(".swal2-confirm").setAttribute("data-clipboard-text",t),h&&h.destroy(),h=new r(".swal2-confirm"),h.on("success",(function(t){a({text:"复制成功",duration:1e3,gravity:"bottom",position:"center",style:{position:"fixed",margin:"0 auto",left:0,right:0,width:"80px",textAlign:"center",background:"black",zIndex:"999999",padding:"5px",opacity:.8,borderRadius:"5px",color:"white"}}).showToast(),t.clearSelection()}))})():(()=>{const t=p().map((t=>`${JSON.stringify(t,null,2)}\n`));var i=new Blob(t,{type:"text/plain;charset=utf-8"});const s=`${e()}.dat`;o.saveAs(i,s)})()}):i.fire({title:"暂无异常",text:"稍后窗口会自动关闭",icon:"success",heightAuto:!1,timer:2e3})},l.prototype.toggleShow=function(){i.isVisible()||this.createPage()},f.prototype={init(t){this.showPage=new l(this.csi.report.bind(this.csi),t),t.customPanelTrigger||this.bindDefaultTrigger()},onTapQueue(t,e){const o=this.tapQueue.length?this.tapQueue[this.tapQueue.length-1]:null;if(o&&t.timeStamp-o.timeStamp>300&&(this.tapQueue=[]),this.tapQueue.push(t),this.tapQueue.length===e)return this.tapQueue=[],!0}},f.prototype.bindDefaultTrigger=function(){document.querySelector("html").addEventListener("touchend",(t=>{this.onTapQueue(t,4)&&setTimeout(this.toggleShow.bind(this),100)})),document.addEventListener("keydown",(t=>{(t=t||window.event).ctrlKey&&6===parseInt(t.key,10)&&this.showPage.toggleShow()}))},f.prototype.toggleShow=function(){this.showPage.toggleShow()};const m=function(t){this.forms=t};m.prototype.probe=function(){const{onerror:t}=window;window.onerror=(...e)=>{var o,i,s,n,r,a;"function"==typeof t&&t.apply(this,e),o=this.forms,i=e[0],s=e[1],n=e[2],r=e[3],a=e[4],o.addLine({etype:"JS_ERROR",msg:`${i} \n ${a&&a.stack}`,js:`${s}:${n}:${r}`})}};const g={},y=function(t){this.forms=t},w=(t,e,o)=>{t.addLine({etype:"XHR_ERROR",msg:e,js:o.join(" :")})};y.prototype.probe=function(t=!1,o){const i=this;this.logAjaxTrace=t,this.excludeKeywords=o||[];const{open:s,send:n,setRequestHeader:r}=XMLHttpRequest.prototype,a=t=>{for(let e=0;e<this.excludeKeywords.length;e++)if(-1!==t.indexOf(this.excludeKeywords[e]))return!0;return!1};XMLHttpRequest.prototype.open=function(){const t=[...arguments];if(t[1]&&a(t[1]))return s.apply(this,arguments);const o=e();this.__xhrid=o,i.addListener(this,arguments),s.apply(this,arguments)},XMLHttpRequest.prototype.setRequestHeader=function(){if(!this.__xhrid)return r.apply(this,arguments);const[t,e]=[...arguments];"content-type"===t.toLowerCase()&&e.toLowerCase().includes("application/json")&&(g[this.__xhrid].recordPayload=!0),r.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){if(!this.__xhrid)return n.apply(this,arguments);g[this.__xhrid].recordPayload&&(g[this.__xhrid].payload=[...arguments]),n.apply(this,arguments)}},y.prototype.addListener=function(t,e){if(g[t.__xhrid])return;g[t.__xhrid]={xhr:t};const{ontimeout:o}=t;t.addEventListener("loadend",(()=>{const o=t.status;let i,s=g[t.__xhrid].payload||{};try{s=JSON.parse(s)}catch(t){s=s}try{i=JSON.parse(t.response)}catch(e){i=t.response}const n={status:o,payload:s,response:i};0!==parseInt(o)&&(/^2[0-9]{1,3}/gi.test(o)?this.logAjaxTrace&&((t,e,o)=>{t.addLine({etype:"XHR_TRACE",msg:e,js:o.join(":")})})(this.forms,n,[...e]):w(this.forms,n,[...e]))})),t.addEventListener("error",(()=>{w(this.forms,t.status||"networkError",[...e])})),t.ontimeout=(...i)=>{this.forms.addLine({etype:"ajax error",msg:`timeout ${t.status}`,js:e.join(" :")}),o&&o.apply(this,i)}};const x=function(t){this.forms=t};x.prototype.probe=function(){if(!window.fetch)return;const t=window.fetch;window.fetch=(e,o)=>{let i="GET",s=e||"";return"string"==typeof e?i=o&&o.method?o.method:i:"[object Request]"===Object.prototype.toString.call(e)&&(i=e.method||i,s=e.url||""),t(e,o).then((t=>{const e=`${t.status}`;return/^2[0-9]{1,3}/gi.test(e)||0==+e||this.forms.addLine({etype:"fetch error",msg:`status:${t.status}`,js:`${i} :${s}`}),t})).catch((t=>{let e;try{e=t&&t.message?t.message:JSON.stringify(t)}catch(o){e=t&&t.message?t.message:t}throw this.forms.addLine({etype:"fetch error",msg:e,js:`${i} :${s}`}),t}))}};const _=function(t,e){this.storage=new c(t,e)};_.prototype={addLine(t){const o={pid:e(),time:Date.now(),ua:navigator.userAgent,url:location?location.href:""};setTimeout((()=>{this.storage.addLine(Object.assign(o,t))}),0)}};class b{constructor(t={}){t.report=t.report||(()=>{console.warn("report needs to be defined")}),t.operationMethod=t.operationMethod||"download",this.inited=!1;try{this.checkParams(t),this.init(t)}catch(t){console.error(t)}}checkParams(t){if(!t.feID)throw Error("feID必传");if(!["download","upload"].includes(t.operationMethod)){const e=[`mara warning: the operationMethod ${t.operationMethod} is not supported`,"please select from either 'download' or 'upload'"];throw Error(e.join("\n"))}}init(t){try{this.opts=t;const e=new _(t.feID,t.maxLine);this.forms=e,this.panel=new f(this),this.panel.init(t),new m(e).probe(),new y(e).probe(t.logAjaxTrace,t.excludeAjaxKeywords),new x(e).probe(),this.inited=!0}catch(t){console.error(t)}if(t.containerFontSize){const e=document.createElement("style");e.innerText=`.swal2-popup {font-size: ${t.containerFontSize}}`,document.head.appendChild(e)}}probe(...t){this.forms.addLine({etype:"CUSTOM_LOG",msg:t})}report(){const t=p();t.length&&this.opts.report(t)}showPanel(){this.panel.toggleShow()}}export{b as default};
